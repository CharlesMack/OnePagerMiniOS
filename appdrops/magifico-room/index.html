<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magifico's Magic Show</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Trebuchet MS', serif;
            background: linear-gradient(45deg, #1a0033, #330066, #4a0080);
            overflow: hidden;
            color: white;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            pointer-events: all;
        }

        .magic-button {
            padding: 12px 24px;
            border: 2px solid gold;
            background: linear-gradient(135deg, #4a0080, #6600cc);
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
        }

        .magic-button:hover {
            background: linear-gradient(135deg, #6600cc, #8000ff);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            transform: translateY(-3px);
        }

        .magic-button:active {
            transform: translateY(-1px);
        }

        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid gold;
            text-align: center;
            font-size: 18px;
            pointer-events: all;
            min-width: 300px;
        }

        #voice-status {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(128, 0, 255, 0.8);
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .curtain {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, #8B0000, #DC143C);
            z-index: 1000;
            transition: transform 1s ease-in-out;
        }

        .curtain.left {
            left: 0;
            transform-origin: left;
        }

        .curtain.right {
            right: 0;
            transform-origin: right;
        }

        .curtain.open.left {
            transform: translateX(-100%);
        }

        .curtain.open.right {
            transform: translateX(100%);
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle 1s ease-out forwards;
        }

        @keyframes sparkle {
            0% {
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0) rotate(360deg);
            }
        }

        #instructions {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid gold;
            max-width: 250px;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="magic-canvas"></canvas>
        
        <div class="curtain left"></div>
        <div class="curtain right"></div>
        
        <div id="ui-overlay">
            <div id="status">üé© Welcome to Magifico's Magic Show! üêá</div>
            <div id="voice-status">Listening for magic words...</div>
            
            <div id="controls">
                <button class="magic-button" onclick="doTrick()">‚ú® Do Trick</button>
                <button class="magic-button" onclick="rabbitPop()">üêá Rabbit Pop</button>
                <button class="magic-button" onclick="startShow()">üé≠ Start Show</button>
            </div>
            
            <div id="instructions">
                <strong>üé™ Voice Commands:</strong><br>
                Say "Trick" or "Abracadabra" for vanish<br>
                Say "Rabbit" for rabbit magic<br>
                Say "Show" to start performance<br>
                <br>
                <strong>Click anywhere on stage for surprises!</strong>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera, renderer, magifico, rabbit, hat, wand, stage;
        let magicParticles = [];
        let spotlights = [];
        let showStarted = false;
        let magificoVisible = true;
        let rabbitVisible = false;
        let isListening = false;
        let recognition;
        
        // Magic states
        const STATES = {
            IDLE: 'idle',
            PERFORMING: 'performing',
            VANISHED: 'vanished',
            RABBIT_SHOW: 'rabbit_show'
        };
        let currentState = STATES.IDLE;

        // Initialize the magic show
        function init() {
            setupScene();
            createStage();
            createMagifico();
            createRabbit();
            createLighting();
            setupVoiceRecognition();
            animate();
            
            // Open curtains after a moment
            setTimeout(openCurtains, 1000);
        }

        function setupScene() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a0033, 10, 50);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 15);
            camera.lookAt(0, 2, 0);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('magic-canvas'),
                antialias: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x1a0033);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Handle clicks on the canvas
            renderer.domElement.addEventListener('click', onStageClick);
        }

        function createStage() {
            // Velvet stage floor
            const stageGeometry = new THREE.PlaneGeometry(20, 15);
            const stageMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x8B0000,
                transparent: true,
                opacity: 0.9
            });
            stage = new THREE.Mesh(stageGeometry, stageMaterial);
            stage.rotation.x = -Math.PI / 2;
            stage.receiveShadow = true;
            scene.add(stage);

            // Stage backdrop
            const backdropGeometry = new THREE.PlaneGeometry(20, 12);
            const backdropMaterial = new THREE.MeshLambertMaterial({ color: 0x4B0082 });
            const backdrop = new THREE.Mesh(backdropGeometry, backdropMaterial);
            backdrop.position.set(0, 6, -5);
            scene.add(backdrop);

            // Decorative elements
            for (let i = 0; i < 5; i++) {
                const star = createStar();
                star.position.set(
                    (Math.random() - 0.5) * 15,
                    8 + Math.random() * 3,
                    -4
                );
                scene.add(star);
            }
        }

        function createStar() {
            const starGeometry = new THREE.ConeGeometry(0.1, 0.5, 5);
            const starMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xFFD700,
                emissive: 0xFFD700,
                emissiveIntensity: 0.3
            });
            return new THREE.Mesh(starGeometry, starMaterial);
        }

        function createMagifico() {
            const magificoGroup = new THREE.Group();
            
            // Body (cylinder)
            const bodyGeometry = new THREE.CylinderGeometry(0.8, 1, 3, 8);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x4B0082 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1.5;
            body.castShadow = true;
            magificoGroup.add(body);
            
            // Head (sphere)
            const headGeometry = new THREE.SphereGeometry(0.6, 8, 6);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFFDBB5 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 3.5;
            head.castShadow = true;
            magificoGroup.add(head);
            
            // Top hat
            const hatGroup = new THREE.Group();
            const hatBrimGeometry = new THREE.CylinderGeometry(1.2, 1.2, 0.1, 16);
            const hatBrimMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            const hatBrim = new THREE.Mesh(hatBrimGeometry, hatBrimMaterial);
            hatBrim.position.y = 4.1;
            hatGroup.add(hatBrim);
            
            const hatTopGeometry = new THREE.CylinderGeometry(0.8, 0.8, 1.5, 16);
            const hatTopMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            hat = new THREE.Mesh(hatTopGeometry, hatTopMaterial);
            hat.position.y = 4.9;
            hat.castShadow = true;
            hatGroup.add(hat);
            magificoGroup.add(hatGroup);
            
            // Wand
            const wandGeometry = new THREE.CylinderGeometry(0.02, 0.02, 2, 8);
            const wandMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            wand = new THREE.Mesh(wandGeometry, wandMaterial);
            wand.position.set(1.5, 2.5, 0);
            wand.rotation.z = Math.PI / 4;
            magificoGroup.add(wand);
            
            // Wand tip
            const tipGeometry = new THREE.SphereGeometry(0.1, 8, 6);
            const tipMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xFFFFFF,
                emissive: 0xFFFFFF,
                emissiveIntensity: 0.5
            });
            const tip = new THREE.Mesh(tipGeometry, tipMaterial);
            tip.position.set(1.5, 3.5, 0);
            magificoGroup.add(tip);
            
            magificoGroup.position.set(0, 0, 0);
            magifico = magificoGroup;
            scene.add(magifico);
        }

        function createRabbit() {
            const rabbitGroup = new THREE.Group();
            
            // Body
            const bodyGeometry = new THREE.SphereGeometry(0.3, 8, 6);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.3;
            body.castShadow = true;
            rabbitGroup.add(body);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.25, 8, 6);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xFFFFFF });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.7;
            rabbitGroup.add(head);
            
            // Ears
            const earGeometry = new THREE.SphereGeometry(0.1, 6, 8);
            const earMaterial = new THREE.MeshLambertMaterial({ color: 0xFFB6C1 });
            const leftEar = new THREE.Mesh(earGeometry, earMaterial);
            leftEar.position.set(-0.15, 0.9, 0);
            leftEar.scale.y = 2;
            const rightEar = new THREE.Mesh(earGeometry, earMaterial);
            rightEar.position.set(0.15, 0.9, 0);
            rightEar.scale.y = 2;
            rabbitGroup.add(leftEar);
            rabbitGroup.add(rightEar);
            
            // Nose
            const noseGeometry = new THREE.SphereGeometry(0.03, 6, 4);
            const noseMaterial = new THREE.MeshLambertMaterial({ color: 0xFF69B4 });
            const nose = new THREE.Mesh(noseGeometry, noseMaterial);
            nose.position.set(0, 0.7, 0.25);
            rabbitGroup.add(nose);
            
            rabbitGroup.position.set(0, 5, 0); // Inside hat initially
            rabbitGroup.visible = false;
            rabbit = rabbitGroup;
            scene.add(rabbit);
        }

        function createLighting() {
            // Main spotlight
            const spotlight = new THREE.SpotLight(0xFFFFFF, 1.5);
            spotlight.position.set(0, 15, 8);
            spotlight.target.position.set(0, 2, 0);
            spotlight.angle = Math.PI / 6;
            spotlight.penumbra = 0.3;
            spotlight.decay = 2;
            spotlight.distance = 30;
            spotlight.castShadow = true;
            scene.add(spotlight);
            scene.add(spotlight.target);
            spotlights.push(spotlight);
            
            // Side lights
            const leftLight = new THREE.SpotLight(0x8000FF, 0.8);
            leftLight.position.set(-10, 12, 5);
            leftLight.target.position.set(0, 2, 0);
            leftLight.angle = Math.PI / 4;
            scene.add(leftLight);
            scene.add(leftLight.target);
            
            const rightLight = new THREE.SpotLight(0xFF00FF, 0.8);
            rightLight.position.set(10, 12, 5);
            rightLight.target.position.set(0, 2, 0);
            rightLight.angle = Math.PI / 4;
            scene.add(rightLight);
            scene.add(rightLight.target);
            
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x4B0082, 0.3);
            scene.add(ambientLight);
        }

        function openCurtains() {
            const curtains = document.querySelectorAll('.curtain');
            curtains.forEach(curtain => curtain.classList.add('open'));
            updateStatus("üé™ Ladies and gentlemen, presenting Magifico the Magician!");
        }

        function startShow() {
            showStarted = true;
            updateStatus("üé≠ The show begins! Watch closely...");
            
            // Dramatic lighting change
            spotlights[0].intensity = 2;
            
            // Wand animation
            animateWand();
            
            setTimeout(() => {
                updateStatus("‚ú® Ready for magic! Use buttons or voice commands!");
            }, 3000);
        }

        function doTrick() {
            if (currentState === STATES.PERFORMING) return;
            
            currentState = STATES.PERFORMING;
            updateStatus("‚ú® Abracadabra! Watch Magifico vanish!");
            
            createMagicParticles(0, 3, 0);
            animateWand();
            
            // Magifico vanishes
            setTimeout(() => {
                magifico.visible = false;
                magificoVisible = false;
                currentState = STATES.VANISHED;
                updateStatus("üé© Magifico has vanished! Click the hat to bring him back!");
                
                // Make hat glow
                hat.material.emissive.setHex(0xFFD700);
                hat.material.emissiveIntensity = 0.3;
            }, 1000);
        }

        function rabbitPop() {
            if (currentState === STATES.PERFORMING) return;
            
            currentState = STATES.RABBIT_SHOW;
            updateStatus("üêá Here comes the rabbit!");
            
            createMagicParticles(0, 5, 0);
            
            if (!rabbitVisible) {
                // Rabbit appears
                rabbit.visible = true;
                rabbit.position.set(0, 5, 0);
                
                // Animate rabbit popping out
                const targetY = 6;
                animateRabbit(targetY);
                rabbitVisible = true;
                
                setTimeout(() => {
                    updateStatus("ü•ï The rabbit is out! Say 'Rabbit' to make it disappear!");
                    currentState = STATES.IDLE;
                }, 1000);
                
            } else {
                // Rabbit disappears
                animateRabbit(4.8);
                setTimeout(() => {
                    rabbit.visible = false;
                    rabbitVisible = false;
                    updateStatus("üé© The rabbit has vanished back into the hat!");
                    currentState = STATES.IDLE;
                }, 800);
            }
        }

        function onStageClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            // Convert screen coordinates to world coordinates
            const vector = new THREE.Vector3(x, y, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = -camera.position.y / dir.y;
            const pos = camera.position.clone().add(dir.multiplyScalar(distance));
            
            createMagicParticles(pos.x, 2, pos.z);
            
            // Special interactions
            if (!magificoVisible && currentState === STATES.VANISHED) {
                // Bring back Magifico
                bringBackMagifico();
            } else if (Math.abs(pos.x) < 1 && Math.abs(pos.z) < 1) {
                // Clicked near center - surprise!
                surpriseEffect();
            }
        }

        function bringBackMagifico() {
            updateStatus("üé≠ The magic returns Magifico!");
            createMagicParticles(0, 3, 0);
            
            setTimeout(() => {
                magifico.visible = true;
                magificoVisible = true;
                hat.material.emissive.setHex(0x000000);
                hat.material.emissiveIntensity = 0;
                currentState = STATES.IDLE;
                updateStatus("üëè Magifico is back! What's next?");
            }, 1000);
        }

        function surpriseEffect() {
            updateStatus("üéâ Surprise magic burst!");
            
            // Create multiple particle bursts
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    createMagicParticles(
                        (Math.random() - 0.5) * 4,
                        2 + Math.random() * 2,
                        (Math.random() - 0.5) * 3
                    );
                }, i * 200);
            }
            
            // Temporary lighting effect
            spotlights[0].intensity = 3;
            setTimeout(() => {
                spotlights[0].intensity = 1.5;
            }, 500);
        }

        function createMagicParticles(x, y, z) {
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const geometry = new THREE.SphereGeometry(0.05, 4, 3);
                const material = new THREE.MeshBasicMaterial({ 
                    color: Math.random() > 0.5 ? 0xFFD700 : 0xFFFFFF,
                    emissive: Math.random() > 0.5 ? 0xFFD700 : 0xFFFFFF,
                    emissiveIntensity: 0.5
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.set(x, y, z);
                
                // Random velocity
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.2,
                    Math.random() * 0.15,
                    (Math.random() - 0.5) * 0.2
                );
                particle.life = 1.0;
                
                magicParticles.push(particle);
                scene.add(particle);
            }
            
            // Create DOM sparkles
            createDOMSparkles(x, y, z);
        }

        function createDOMSparkles(worldX, worldY, worldZ) {
            const vector = new THREE.Vector3(worldX, worldY, worldZ);
            vector.project(camera);
            
            const screenX = (vector.x + 1) / 2 * window.innerWidth;
            const screenY = -(vector.y - 1) / 2 * window.innerHeight;
            
            for (let i = 0; i < 10; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = (screenX + (Math.random() - 0.5) * 100) + 'px';
                sparkle.style.top = (screenY + (Math.random() - 0.5) * 100) + 'px';
                document.body.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function animateWand() {
            if (!wand) return;
            
            const originalRotation = wand.rotation.z;
            const animation = () => {
                wand.rotation.z = originalRotation + Math.sin(Date.now() * 0.02) * 0.5;
            };
            
            const animateFrame = () => {
                animation();
                if (Date.now() % 100 < 10) { // Animate for about 2 seconds
                    requestAnimationFrame(animateFrame);
                } else {
                    wand.rotation.z = originalRotation;
                }
            };
            
            // Run animation for 2 seconds
            const endTime = Date.now() + 2000;
            const animateLoop = () => {
                if (Date.now() < endTime) {
                    animation();
                    requestAnimationFrame(animateLoop);
                } else {
                    wand.rotation.z = originalRotation;
                }
            };
            animateLoop();
        }

        function animateRabbit(targetY) {
            if (!rabbit) return;
            
            const startY = rabbit.position.y;
            const duration = 800;
            const startTime = Date.now();
            
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3); // Ease out cubic
                
                rabbit.position.y = startY + (targetY - startY) * easeProgress;
                
                // Add some bounce
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            
            animate();
        }

        function updateParticles() {
            for (let i = magicParticles.length - 1; i >= 0; i--) {
                const particle = magicParticles[i];
                
                // Update position
                particle.position.add(particle.velocity);
                particle.velocity.y -= 0.01; // Gravity
                particle.life -= 0.02;
                
                // Fade out
                particle.material.opacity = particle.life;
                
                // Remove dead particles
                if (particle.life <= 0) {
                    scene.remove(particle);
                    magicParticles.splice(i, 1);
                }
            }
        }

        function setupVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voice-status').style.opacity = '1';
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript.toLowerCase();
                        }
                    }

                    if (finalTranscript) {
                        handleVoiceCommand(finalTranscript);
                    }
                };

                recognition.onerror = () => {
                    document.getElementById('voice-status').style.opacity = '0';
                };

                recognition.onend = () => {
                    if (isListening) {
                        recognition.start(); // Keep listening
                    }
                };

                recognition.start();
            } else {
                document.getElementById('voice-status').textContent = 'Voice commands not supported';
                setTimeout(() => {
                    document.getElementById('voice-status').style.opacity = '0';
                }, 3000);
            }
        }

        function handleVoiceCommand(command) {
            document.getElementById('voice-status').textContent = `Heard: "${command}"`;
            setTimeout(() => {
                document.getElementById('voice-status').style.opacity = '0';
            }, 2000);

            if (command.includes('trick') || command.includes('abracadabra')) {
                doTrick();
            } else if (command.includes('rabbit')) {
                rabbitPop();
            } else if (command.includes('show') || command.includes('start')) {
                startShow();
            }
        }

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Update particles
            updateParticles();
            
            // Gentle wand movement when idle
            if (wand && currentState === STATES.IDLE) {
                wand.rotation.z = Math.PI / 4 + Math.sin(Date.now() * 0.001) * 0.1;
            }
            
            // Rabbit ear twitching
            if (rabbit && rabbitVisible && currentState === STATES.IDLE) {
                const time = Date.now() * 0.005;
                rabbit.children[2].rotation.z = Math.sin(time) * 0.2; // Left ear
                rabbit.children[3].rotation.z = Math.sin(time + 1) * 0.2; // Right ear
            }
            
            // Camera gentle movement
            camera.position.x = Math.sin(Date.now() * 0.0005) * 0.5;
            camera.lookAt(0, 2, 0);
            
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start the show!
        init();
    </script>
</body>
</html>
