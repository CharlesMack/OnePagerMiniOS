<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Performance Monitor</title>
  <meta name="description" content="Monitors device load, page memory, FPS, and analytics with local storage history." />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a160b;
      color: #fff;
      margin: 0;
      padding: 20px;
      font-size: 16px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    details {
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin-bottom: 5px;
    }
    button {
      background: #00ff7f;
      border: none;
      color: #000;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      opacity: 0.9;
    }
    #fpsGraph {
      width: 100%;
      height: 150px;
      border: 1px solid #fff;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Performance Monitor</h1>
  
  <details open>
    <summary>Real-Time Stats</summary>
    <ul>
      <li>FPS: <span id="fps">Calculating...</span></li>
      <li>Memory Usage (JS Heap): <span id="memory">N/A</span></li>
      <li>Device Memory: <span id="deviceMemory">N/A GB</span></li>
      <li>Page Load Time: <span id="loadTime">N/A ms</span></li>
    </ul>
    <canvas id="fpsGraph"></canvas>
  </details>
  
  <details>
    <summary>Analytics History (from Local Storage)</summary>
    <ul id="historyTree"></ul>
    <button id="clearHistory">Clear History</button>
  </details>

  <script>
    // FPS Calculation
    let lastTime = performance.now();
    let frameCount = 0;
    let fps = 0;
    const fpsHistory = [];
    const maxHistory = 60; // Last 60 seconds for graph

    function calculateFPS() {
      const now = performance.now();
      frameCount++;
      if (now - lastTime >= 1000) {
        fps = frameCount;
        document.getElementById('fps').textContent = fps;
        fpsHistory.push(fps);
        if (fpsHistory.length > maxHistory) fpsHistory.shift();
        drawFPSGraph();
        frameCount = 0;
        lastTime = now;
      }
      requestAnimationFrame(calculateFPS);
    }

    function drawFPSGraph() {
      const canvas = document.getElementById('fpsGraph');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = 150;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#00ff7f';
      ctx.beginPath();
      const step = canvas.width / maxHistory;
      fpsHistory.forEach((val, i) => {
        ctx.lineTo(i * step, canvas.height - (val / 60 * canvas.height)); // Scale to 60 FPS max
      });
      ctx.stroke();
    }

    // Memory Usage
    function updateMemory() {
      if ('memory' in performance) {
        const mem = performance.memory;
        document.getElementById('memory').textContent = `${(mem.usedJSHeapSize / 1048576).toFixed(2)} / ${(mem.jsHeapSizeLimit / 1048576).toFixed(2)} MB`;
      } else {
        document.getElementById('memory').textContent = 'Not supported';
      }
      if ('deviceMemory' in navigator) {
        document.getElementById('deviceMemory').textContent = navigator.deviceMemory;
      }
    }

    // Page Load Time
    function getLoadTime() {
      const timing = performance.timing;
      const loadTime = timing.loadEventEnd - timing.navigationStart;
      document.getElementById('loadTime').textContent = loadTime > 0 ? `${loadTime} ms` : 'N/A';
    }

    // Local Storage History
    const STORAGE_KEY = 'performanceHistory';
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const tree = document.getElementById('historyTree');
      tree.innerHTML = '';
      history.forEach((entry, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<details><summary>Entry ${index + 1} (${new Date(entry.timestamp).toLocaleString()})</summary>
          <ul>
            <li>FPS: ${entry.fps}</li>
            <li>Memory Used: ${entry.memoryUsed} MB</li>
            <li>Load Time: ${entry.loadTime} ms</li>
          </ul>
        </details>`;
        tree.appendChild(li);
      });
    }

    function saveHistory() {
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      history.push({
        timestamp: Date.now(),
        fps,
        memoryUsed: performance.memory ? (performance.memory.usedJSHeapSize / 1048576).toFixed(2) : 'N/A',
        loadTime: performance.timing.loadEventEnd - performance.timing.navigationStart
      });
      if (history.length > 100) history.shift(); // Limit to 100 entries
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      loadHistory();
    }

    document.getElementById('clearHistory').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      loadHistory();
    });

    // Update every second
    setInterval(() => {
      updateMemory();
      saveHistory();
    }, 1000);

    // Initial setup
    getLoadTime();
    calculateFPS();
    updateMemory();
    loadHistory();
  </script>
</body>
</html>
