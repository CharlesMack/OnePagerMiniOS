<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mack TimeLoom v2.0 ‚Äî Forge Your Empire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
    <style>
        :root {
            --neon-cyan: #00ffff;
            --dark-bg: #0a0a0a;
            --card-bg: #111111;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --accent-gradient: linear-gradient(135deg, #00ffff, #0099cc);
            --danger-color: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 153, 204, 0.1) 0%, transparent 50%);
            z-index: -1; animation: backgroundShift 10s ease-in-out infinite alternate;
        }
        @keyframes backgroundShift {
            0% { transform: scale(1) rotate(0deg); } 100% { transform: scale(1.1) rotate(1deg); }
        }

        /* Header Branding */
        .brand-header {
            text-align: center; padding: 2rem 0;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(17, 17, 17, 0.9));
            border-bottom: 2px solid var(--neon-cyan); margin-bottom: 2rem;
        }
        .brand-title {
            font-size: 2.5rem; font-weight: 700; background: var(--accent-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 0.5rem; text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .brand-tagline { color: var(--text-secondary); font-size: 1.1rem; font-weight: 400; margin-bottom: 1rem; }

        .header-stats { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; }
        .drip-balance-display {
            display: inline-block; background: var(--card-bg); padding: 0.75rem 1.5rem;
            border-radius: 25px; border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); font-weight: 600;
            animation: pulse 2s ease-in-out infinite alternate;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); } 100% { box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); }
        }

        /* Main Layout */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 0 1rem 100px; }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 992px) { .grid-container { grid-template-columns: 1fr 1fr; } }

        /* Card Styles */
        .card-neon {
            background: var(--card-bg); border-radius: 20px; padding: 2rem;
            border: 1px solid rgba(0, 255, 255, 0.2); backdrop-filter: blur(10px);
        }
        .section-title {
            font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;
            text-align: center; color: var(--neon-cyan);
        }

        /* Categories Section */
        #category-options {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem; margin-bottom: 2rem;
        }
        .category-btn {
            padding: 1rem; border: 2px solid transparent; border-radius: 15px; background: rgba(0,0,0,0.2);
            color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; text-align: center; min-height: 60px;
            font-size: 0.9rem; position: relative;
        }
        .category-btn:hover {
            background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan); transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }
        .category-btn.selected {
            background: var(--accent-gradient); color: var(--dark-bg); transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .delete-icon {
            position: absolute; top: -8px; right: -8px; background: var(--danger-color); border-radius: 50%;
            color: white; font-size: 0.7rem; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .category-btn:hover .delete-icon { opacity: 1; }

        /* Timer Section */
        #timer-display {
            font-size: clamp(3rem, 10vw, 4rem); font-weight: 700; margin: 2rem 0;
            background: var(--accent-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            text-shadow: 0 0 30px rgba(0, 255, 255, 0.5); animation: timerGlow 2s ease-in-out infinite alternate;
        }
        @keyframes timerGlow {
            0% { filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.3)); } 100% { filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.6)); }
        }
        #status-message { font-size: 1.1rem; margin-bottom: 2rem; color: var(--text-secondary); font-weight: 500; min-height: 2rem; }
        .controls { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; flex-wrap: wrap; }
        .controls button, .action-btn {
            background: var(--accent-gradient); color: var(--dark-bg); border: none; padding: 0.75rem 1.5rem;
            border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .controls button:hover, .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4); }

        /* Legacy Dashboard Section */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .stat-card { background: rgba(0, 255, 255, 0.05); padding: 1.5rem; border-radius: 15px; border: 1px solid rgba(0, 255, 255, 0.2); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--neon-cyan); }
        .stat-label { font-size: 1rem; color: var(--text-secondary); }
        #log-container { margin-top: 2rem; max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .log-entry {
            background: var(--card-bg); border-left: 4px solid var(--neon-cyan); padding: 1rem; border-radius: 8px;
            margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;
        }
        .log-entry p { margin: 0; }
        .log-category { font-weight: bold; }
        .log-time { color: var(--text-secondary); }

        /* Utilities */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(0, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--neon-cyan); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .achievement-toast { position: fixed; top: 20px; right: 20px; background: var(--accent-gradient); color: var(--dark-bg); padding: 1rem 1.5rem; border-radius: 15px; font-weight: 600; transform: translateX(120%); transition: transform 0.5s ease; z-index: 1001; box-shadow: 0 5px 20px rgba(0, 255, 255, 0.4); }
        .achievement-toast.show { transform: translateX(0); }
    </style>
</head>
<body>
    <header class="brand-header">
        <h1 class="brand-title">‚è≥ Mack TimeLoom v2.0</h1>
        <p class="brand-tagline">From Akron to AI, Build Your Empire One Drop at a Time</p>
        <div class="header-stats">
            <div class="drip-balance-display" id="dripBalance">
                <span class="loading-spinner"></span>
            </div>
            <div class="drip-balance-display" id="forgeRank">
                <span class="loading-spinner"></span>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="grid-container">
            <div class="control-panel">
                <div class="card-neon" id="timer-card">
                    <h2 class="section-title">‚è±Ô∏è Time Forge</h2>
                    <div id="timer-display" class="text-center">00:00:00</div>
                    <div id="status-message" class="text-center">Select a category to begin.</div>
                    <div class="controls">
                        <button id="start-btn">‚ñ∂Ô∏è Start</button>
                        <button id="pause-btn">‚è∏Ô∏è Pause</button>
                        <button id="stop-btn">‚èπÔ∏è Stop</button>
                    </div>
                    <div class="save-drop-section" style="margin-top: 2rem;">
                        <textarea id="drop-caption" class="form-control" placeholder="Capture this moment... What was achieved?" style="background:var(--dark-bg); color:var(--text-primary); border-color:rgba(0,255,255,0.3)"></textarea>
                        <button id="save-drop-btn" class="action-btn w-100 mt-2">üíæ Save as TimeDrop</button>
                    </div>
                </div>

                <div class="card-neon mt-4">
                    <h2 class="section-title">üéØ Focus Categories</h2>
                    <div class="text-center mb-3">Current: <strong id="selectedCategory" style="color:var(--neon-cyan)">None</strong></div>
                    <div id="category-options">
                        <button class="category-btn" data-category="Sleep" data-emoji="üõå">üõå Sleep</button>
                        <button class="category-btn" data-category="Focus" data-emoji="üèãÔ∏è">üèãÔ∏è Focus</button>
                        <button class="category-btn" data-category="Reflection" data-emoji="üîç">üîç Reflection</button>
                        <button class="category-btn" data-category="Study" data-emoji="üìö">üìö Study</button>
                    </div>
                    <div class="input-group mb-3">
                        <input type="text" id="customCategoryInput" class="form-control" placeholder="New Category" style="background:var(--dark-bg); color:var(--text-primary);">
                        <input type="text" id="emojiInput" class="form-control" placeholder="üî∏" style="background:var(--dark-bg); color:var(--text-primary); max-width: 60px;">
                        <button id="addCategoryBtn" class="btn btn-outline-info">‚ûï</button>
                    </div>
                </div>
            </div>

            <div class="card-neon">
                <h2 class="section-title">üìà Legacy Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div id="totalTimeStat" class="stat-value">--</div>
                        <div class="stat-label">Total Time Forged</div>
                    </div>
                    <div class="stat-card">
                        <div id="topCategoryStat" class="stat-value">--</div>
                        <div class="stat-label">Top Category</div>
                    </div>
                    <div class="stat-card">
                        <div id="totalDropsStat" class="stat-value">--</div>
                        <div class="stat-label">Total TimeDrops</div>
                    </div>
                </div>
                <h3 class="section-title mt-4">üìú TimeDrop Log</h3>
                <div id="log-container">
                    <p class="text-center text-secondary">Your saved TimeDrops will appear here.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="achievement-toast" class="achievement-toast"></div>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- APPLICATION STATE ---
        const AppState = {
            DB_KEY: "timeloom_v2_data",
            seconds: 0,
            timerInterval: null,
            isPaused: false,
            selectedCategory: null,
            userData: {
                dripBalance: 0,
                categories: [],
                timeDrops: [],
                achievements: []
            }
        };

        // --- DOM ELEMENTS ---
        const Elements = {
            dripBalance: document.getElementById("dripBalance"),
            forgeRank: document.getElementById("forgeRank"),
            timerDisplay: document.getElementById("timer-display"),
            statusMessage: document.getElementById("status-message"),
            startBtn: document.getElementById("start-btn"),
            pauseBtn: document.getElementById("pause-btn"),
            stopBtn: document.getElementById("stop-btn"),
            categoryOptions: document.getElementById("category-options"),
            selectedCategoryLabel: document.getElementById("selectedCategory"),
            categoryInput: document.getElementById("customCategoryInput"),
            emojiInput: document.getElementById("emojiInput"),
            addBtn: document.getElementById("addCategoryBtn"),
            saveDropBtn: document.getElementById("save-drop-btn"),
            dropCaption: document.getElementById("drop-caption"),
            achievementToast: document.getElementById("achievement-toast"),
            logContainer: document.getElementById("log-container"),
            totalTimeStat: document.getElementById("totalTimeStat"),
            topCategoryStat: document.getElementById("topCategoryStat"),
            totalDropsStat: document.getElementById("totalDropsStat"),
            timerCard: document.getElementById("timer-card"),
        };

        // --- MOCK API / DATA PERSISTENCE ---
        const DataService = {
            load() {
                const data = localStorage.getItem(AppState.DB_KEY);
                if (data) {
                    AppState.userData = JSON.parse(data);
                }
                this.save(); // Save to ensure structure is up-to-date
            },
            save() {
                localStorage.setItem(AppState.DB_KEY, JSON.stringify(AppState.userData));
            }
        };

        // --- ACHIEVEMENT MODULE ---
        const Achievement = {
            show(message) {
                if (AppState.userData.achievements.includes(message)) return; // Don't show twice

                AppState.userData.achievements.push(message);
                DataService.save();
                
                Elements.achievementToast.textContent = `üèÜ ${message}`;
                Elements.achievementToast.classList.add("show");
                setTimeout(() => Elements.achievementToast.classList.remove("show"), 4000);
            }
        };

        // --- DRIP & RANK SYSTEM ---
        const DripSystem = {
            RANKS: [
                { name: "Time Novice", minDrip: 0 },
                { name: "Forge Apprentice", minDrip: 500 },
                { name: "Time Journeyman", minDrip: 2000 },
                { name: "Epoch Artificer", minDrip: 5000 },
                { name: "Loom Master", minDrip: 10000 }
            ],
            awardDrip(amount) {
                AppState.userData.dripBalance += amount;
                this.updateDisplay();
                Achievement.show(`${amount} Drip Forged!`);
            },
            updateDisplay() {
                Elements.dripBalance.innerHTML = `üíß ${AppState.userData.dripBalance.toLocaleString()} Drip`;
                const currentRank = this.RANKS.slice().reverse().find(r => AppState.userData.dripBalance >= r.minDrip);
                Elements.forgeRank.innerHTML = `üéñÔ∏è ${currentRank.name}`;
            }
        };
        
        // --- CATEGORY MANAGER ---
        const CategoryManager = {
            render() {
                // Clear only custom buttons
                Elements.categoryOptions.querySelectorAll("[data-custom='true']").forEach(btn => btn.remove());
                AppState.userData.categories.forEach(cat => this.createButtonDOM(cat.label, cat.emoji, true));
            },
            selectCategory(btn) {
                document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                AppState.selectedCategory = { label: btn.dataset.category, emoji: btn.dataset.emoji };
                Elements.selectedCategoryLabel.textContent = `${btn.dataset.emoji} ${btn.dataset.category}`;
                Timer.updateStatus();
            },
            add(label, emoji) {
                if (!label) { alert("Category name is required."); return; }
                const exists = [...document.querySelectorAll(".category-btn")].some(b => b.dataset.category.toLowerCase() === label.toLowerCase());
                if (exists) { alert("Category already exists."); return; }

                AppState.userData.categories.push({ label, emoji });
                DataService.save();
                this.createButtonDOM(label, emoji, true);
                Elements.categoryInput.value = "";
                Elements.emojiInput.value = "";
                if(AppState.userData.categories.length === 1) Achievement.show("Customizer: First category created!");
            },
            createButtonDOM(label, emoji, isCustom) {
                const btn = document.createElement("button");
                btn.className = "category-btn";
                btn.dataset.category = label;
                btn.dataset.emoji = emoji;
                btn.innerHTML = `${emoji} ${label}`;
                if (isCustom) {
                    btn.dataset.custom = "true";
                    // Add delete icon for custom categories
                    const deleteIcon = document.createElement("span");
                    deleteIcon.className = "delete-icon";
                    deleteIcon.innerHTML = "&times;";
                    deleteIcon.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete category "${label}"? This is permanent.`)) {
                            AppState.userData.categories = AppState.userData.categories.filter(c => c.label !== label);
                            DataService.save();
                            this.render();
                        }
                    };
                    btn.appendChild(deleteIcon);
                }
                btn.onclick = () => this.selectCategory(btn);
                Elements.categoryOptions.appendChild(btn);
            },
            init() {
                document.querySelectorAll(".category-btn:not([data-custom='true'])").forEach(btn => {
                    btn.onclick = () => this.selectCategory(btn);
                });
                Elements.addBtn.onclick = () => this.add(Elements.categoryInput.value.trim(), Elements.emojiInput.value.trim() || 'üî∏');
                this.render();
            }
        };
        
        // --- TIMER MODULE ---
        const Timer = {
            updateDisplay() {
                const h = Math.floor(AppState.seconds / 3600);
                const m = Math.floor((AppState.seconds % 3600) / 60);
                const s = AppState.seconds % 60;
                Elements.timerDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            },
            updateStatus() {
                if(AppState.timerInterval) {
                     Elements.statusMessage.textContent = `Forging ${AppState.selectedCategory.emoji} ${AppState.selectedCategory.label}...`;
                } else if(AppState.isPaused) {
                    Elements.statusMessage.textContent = `Paused ${AppState.selectedCategory.label} session.`;
                } else if(AppState.selectedCategory) {
                    Elements.statusMessage.textContent = `Ready to forge ${AppState.selectedCategory.label}.`;
                } else {
                    Elements.statusMessage.textContent = "Select a category to begin.";
                }
            },
            tick() {
                AppState.seconds++;
                this.updateDisplay();
                if (AppState.seconds > 0 && AppState.seconds % 60 === 0) {
                    DripSystem.awardDrip(5); // 5 Drip per minute
                    DataService.save();
                }
            },
            start() {
                if (!AppState.selectedCategory) { alert("Please select a category first."); return; }
                if (AppState.timerInterval) return; // Already running
                
                AppState.isPaused = false;
                AppState.timerInterval = setInterval(() => this.tick(), 1000);
                this.updateStatus();
            },
            pause() {
                if (!AppState.timerInterval) return;
                clearInterval(AppState.timerInterval);
                AppState.timerInterval = null;
                AppState.isPaused = true;
                this.updateStatus();
            },
            stop(isSave = false) {
                if(!isSave && AppState.seconds > 0) {
                     if (!confirm("Stop and discard this session?")) return;
                }
                clearInterval(AppState.timerInterval);
                AppState.timerInterval = null;
                AppState.isPaused = false;
                const finalSeconds = AppState.seconds;
                AppState.seconds = 0;
                this.updateDisplay();
                this.updateStatus();
                return finalSeconds;
            },
            init() {
                Elements.startBtn.onclick = () => this.start();
                Elements.pauseBtn.onclick = () => this.pause();
                Elements.stopBtn.onclick = () => this.stop(false);
            }
        };

        // --- DASHBOARD & SAVING ---
        const Dashboard = {
            saveTimeDrop() {
                const duration = Timer.stop(true);
                if (duration < 10) { // Require at least 10 seconds to save
                    alert("Session too short to be saved as a TimeDrop.");
                    Timer.updateDisplay(); // reset display to 0
                    return;
                }
                const caption = Elements.dropCaption.value.trim();
                const drop = {
                    id: Date.now(),
                    category: AppState.selectedCategory,
                    duration,
                    caption,
                    date: new Date().toISOString()
                };
                AppState.userData.timeDrops.push(drop);
                DataService.save();
                
                // UX Fanfare
                Achievement.show(`TimeDrop Saved! (${Math.floor(duration/60)}m ${duration%60}s)`);
                this.celebrate();

                Elements.dropCaption.value = "";
                this.render();
            },
            celebrate() {
                html2canvas(Elements.timerCard).then(canvas => {
                     // Briefly show the snapshot - can be expanded to save/share
                });
                confetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 }
                });
            },
            render() {
                this.updateStats();
                this.updateLog();
            },
            updateLog() {
                Elements.logContainer.innerHTML = "";
                if (AppState.userData.timeDrops.length === 0) {
                    Elements.logContainer.innerHTML = '<p class="text-center text-secondary">Your saved TimeDrops will appear here.</p>';
                    return;
                }
                const sortedDrops = AppState.userData.timeDrops.slice().reverse();
                sortedDrops.forEach(drop => {
                    const entry = document.createElement("div");
                    entry.className = "log-entry";
                    const durationMins = Math.floor(drop.duration / 60);
                    const durationSecs = drop.duration % 60;
                    entry.innerHTML = `
                        <div>
                            <p class="log-category">${drop.category.emoji} ${drop.category.label}</p>
                            <p>${drop.caption || "No caption."}</p>
                        </div>
                        <div class="text-end">
                             <p class="log-time">${durationMins}m ${durationSecs}s</p>
                             <small>${new Date(drop.date).toLocaleDateString()}</small>
                        </div>
                    `;
                    Elements.logContainer.appendChild(entry);
                });
            },
            updateStats() {
                const drops = AppState.userData.timeDrops;
                Elements.totalDropsStat.textContent = drops.length;

                const totalSeconds = drops.reduce((acc, d) => acc + d.duration, 0);
                const totalHours = (totalSeconds / 3600).toFixed(1);
                Elements.totalTimeStat.textContent = `${totalHours}h`;

                if (drops.length > 0) {
                    const categoryCounts = drops.reduce((acc, d) => {
                        acc[d.category.label] = (acc[d.category.label] || 0) + 1;
                        return acc;
                    }, {});
                    const topCat = Object.keys(categoryCounts).reduce((a, b) => categoryCounts[a] > categoryCounts[b] ? a : b);
                    Elements.topCategoryStat.textContent = topCat;
                } else {
                    Elements.topCategoryStat.textContent = "--";
                }
            },
            init() {
                Elements.saveDropBtn.onclick = () => this.saveTimeDrop();
            }
        };

        // --- INITIALIZATION ---
        function main() {
            DataService.load();
            DripSystem.updateDisplay();
            CategoryManager.init();
            Timer.init();
            Dashboard.init();
            Dashboard.render();
        }

        main();
    });
    </script>
</body>
</html>
