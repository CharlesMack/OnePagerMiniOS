<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>P.O.P.S. Olympic Relay Media Event</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    html { overflow: hidden; min-height: 600px; min-width: 800px; }
    body { margin: 0; background: #f0f0f0; font-family: Arial, sans-serif; }
    canvas { display: block; margin: 0 auto; }
    .controls { position: absolute; top: 10px; left: 10px; z-index: 10; }
    .controls button { margin: 5px; padding: 10px; font-size: 16px; cursor: pointer; }
    .controls button:disabled { cursor: not-allowed; opacity: 0.5; }
    .playlist { position: absolute; top: 100px; left: 10px; background: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 8px; z-index: 10; }
    audio { position: absolute; top: 10px; right: 10px; display: none; }
    h1 { text-align: center; color: white; text-shadow: 2px 2px 4px #000000; }
    .message { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 8px; z-index: 10; display: none; }
  </style>
</head>
<body>
  <h1>P.O.P.S. Olympic Relay Media Event</h1>
  <div class="controls">
    <input type="file" id="fileInput" accept="audio/*" multiple>
    <button onclick="setTheme('relay')">Relay Race</button>
    <button onclick="setTheme('hurdles')">Hurdles</button>
    <button onclick="setTheme('gymnastics')">Gymnastics</button>
    <button id="playPause" onclick="togglePlayback()" disabled>Play/Pause</button>
  </div>
  <div class="playlist">
    <p>Playlist:</p>
    <ul id="playlist"></ul>
  </div>
  <div class="message" id="message">Please select audio files to start the event!</div>
  <audio id="player" onended="playNextTrack()" onerror="handlePlaybackError()"></audio>

  <script>
    let runners = [];
    let playlist = [];
    let currentTrack = 0;
    let isPlaying = false;
    let theme = 'relay';
    let batonHolder = 0;
    let trackRadius = 200;
    let runnerSprite;

    class RunnerSprite {
      constructor() {
        this.spriteWidth = 60;
        this.spriteHeight = 60;
        this.sheet = createGraphics(this.spriteWidth * 8, this.spriteHeight);
        this.drawSprites();
      }

      drawSprites() {
        this.sheet.noStroke();
        this.sheet.background(0, 0, 0, 0); // Transparent background
        this.drawPose(0, 'idle', 0);
        this.drawPose(1, 'idle', 1);
        this.drawPose(2, 'run', 0);
        this.drawPose(3, 'run', 1);
        this.drawPose(4, 'run', 2);
        this.drawPose(5, 'run', 3);
        this.drawPose(6, 'pass');
        this.drawPose(7, 'jump');
      }

      drawPose(xOffset, pose, frame) {
        let gx = xOffset * this.spriteWidth;
        let gy = 0;
        this.sheet.push();
        this.sheet.translate(gx + this.spriteWidth / 2, gy + this.spriteHeight / 2);
        this.sheet.fill(50);
        this.sheet.rectMode(CENTER);
        this.sheet.rect(0, 0, 20, 40); // Body
        this.sheet.fill(200, 150, 100);
        this.sheet.ellipse(0, -25, 20, 20); // Head
        this.sheet.stroke(50);
        this.sheet.strokeWeight(3);
        switch (pose) {
          case 'idle':
            this.sheet.line(-10, -5, -10, 5); // Left arm
            this.sheet.line(10, -5, 10, 5); // Right arm
            this.sheet.line(-5, 20, -5, 30); // Left leg
            this.sheet.line(5, 20, 5, 30); // Right leg
            if (frame === 1) {
              this.sheet.line(-10, -5, -15, 0); // Waving arm
            }
            break;
          case 'run':
            this.sheet.line(-10, -5, -10 + 10 * sin(frame * 0.5), 5 + 10 * cos(frame * 0.5));
            this.sheet.line(10, -5, 10 - 10 * sin(frame * 0.5), 5 - 10 * cos(frame * 0.5));
            this.sheet.line(-5, 20, -5 + 5 * sin(frame * 0.5), 30);
            this.sheet.line(5, 20, 5 - 5 * sin(frame * 0.5), 30);
            break;
          case 'pass':
            this.sheet.line(-10, -5, -10, 10);
            this.sheet.line(10, -5, 10, 10);
            break;
          case 'jump':
            this.sheet.line(-10, -5, -10, -20);
            this.sheet.line(10, -5, 10, -20);
            this.sheet.line(-5, 20, -10, 10); // Bent legs
            this.sheet.line(5, 20, 10, 10);
            break;
        }
        this.sheet.pop();
      }
    }

    function setup() {
      createCanvas(800, 600);
      runnerSprite = new RunnerSprite();
      updateRunners();
      let fileInput = document.getElementById('fileInput');
      fileInput.addEventListener('change', handleFileSelect);
      // Enable drag-and-drop on canvas using p5.js drop function
      drop(handleFileSelect);
    }

    function draw() {
      background(135, 206, 235); // Sky blue
      drawCarnivalBackground();
      drawTrack();
      for (let runner of runners) {
        runner.update();
        runner.display();
      }
    }

    class Runner {
      constructor(angle, id) {
        this.angle = angle;
        this.id = id;
        this.mode = 'idle';
        this.frame = random(0, 1); // Random start for unique animations
        this.frameIndex = {
          'idle': [0, 1],
          'run': [2, 3, 4, 5],
          'pass': [6],
          'jump': [7]
        };
        this.speed = 0.05;
      }

      update() {
        if (isPlaying && this.id === batonHolder) {
          this.mode = (theme === 'relay' || theme === 'hurdles') ? 'run' : 'jump';
          this.angle += this.speed;
          if (this.angle >= TWO_PI) this.angle -= TWO_PI;
        } else if (!isPlaying) {
          this.mode = 'idle';
        } else if (this.id === (batonHolder + 1) % runners.length) {
          this.mode = 'pass';
        } else {
          this.mode = 'idle';
        }
        this.frame = (this.frame + 0.1) % this.frameIndex[this.mode].length;
      }

      display() {
        let x = width / 2 + cos(this.angle) * trackRadius;
        let y = height / 2 + sin(this.angle) * trackRadius;
        push();
        translate(x, y);
        let direction = cos(this.angle) > 0 ? 1 : -1;
        scale(direction, 1);
        let frameIndex = this.frameIndex[this.mode][floor(this.frame)];
        let frameX = frameIndex * runnerSprite.spriteWidth;
        image(runnerSprite.sheet,
              -runnerSprite.spriteWidth / 2, -runnerSprite.spriteHeight, runnerSprite.spriteWidth, runnerSprite.spriteHeight,
              frameX, 0, runnerSprite.spriteWidth, runnerSprite.spriteHeight);
        pop();
      }
    }

    function drawCarnivalBackground() {
      // Sky gradient
      let sky = createGraphics(width, height / 2);
      for (let y = 0; y < height / 2; y++) {
        let c = lerpColor(color(55, 121, 179), color(164, 200, 214), y / (height / 2));
        sky.stroke(c);
        sky.line(0, y, width, y);
      }
      image(sky, 0, 0);

      // Animated sun/moon
      fill(255, 255, 150);
      noStroke();
      ellipse(700 + sin(frameCount * 0.01) * 50, 50, 80, 80);

      // Ferris wheel with cabins
      push();
      translate(100, 100);
      rotate(frameCount * 0.01);
      fill(255, 204, 0);
      ellipse(0, 0, 80, 80);
      stroke(0);
      strokeWeight(2);
      for (let i = 0; i < 8; i++) {
        let a = i * TWO_PI / 8;
        let cx = cos(a) * 40;
        let cy = sin(a) * 40;
        fill(255, random(100, 200), 100);
        ellipse(cx, cy, 10, 10);
      }
      line(0, 0, 0, 40);
      pop();

      // Animated crowd
      fill(100);
      rect(0, height / 2, width, 50);
      for (let i = 0; i < 10; i++) {
        let x = i * width / 10 + sin(frameCount * 0.05 + i) * 5;
        fill(255, random(100, 200), 100);
        ellipse(x, height / 2 + 25, 10, 10);
      }
      textSize(20);
      fill(255);
      textAlign(CENTER);
      text("P.O.P.S. Carnival!", width / 2, 50);
    }

    function drawTrack() {
      push();
      translate(width / 2, height / 2);
      noFill();
      stroke(255);
      strokeWeight(40);
      ellipse(0, 0, trackRadius * 2, trackRadius * 2);
      if (theme === 'hurdles') {
        for (let i = 0; i < 6; i++) {
          let a = i * TWO_PI / 6;
          let x = cos(a) * trackRadius;
          let y = sin(a) * trackRadius;
          fill(139, 69, 19);
          rect(x - 10, y - 10, 20, 20);
        }
      } else if (theme === 'gymnastics') {
        fill(200);
        noStroke();
        rect(-trackRadius, -20, trackRadius * 2, 40);
        rect(-50, -100, 100, 20);
        fill(255, 105, 180);
        ellipse(0, 0, 50);
      }
      pop();
    }

    function setTheme(newTheme) {
      theme = newTheme;
    }

    function handleFileSelect(event) {
      playlist = [];
      let files = event.dataTransfer ? event.dataTransfer.files : event.target.files;
      let playlistElement = document.getElementById('playlist');
      playlistElement.innerHTML = '';
      let validFiles = 0;
      for (let i = 0; i < files.length; i++) {
        if (files[i].type.startsWith('audio/')) {
          let url = URL.createObjectURL(files[i]);
          playlist.push({ name: files[i].name, url: url });
          let li = document.createElement('li');
          li.textContent = files[i].name;
          playlistElement.appendChild(li);
          validFiles++;
        }
      }
      updateRunners();
      let message = document.getElementById('message');
      let playButton = document.getElementById('playPause');
      if (validFiles === 0 && files.length > 0) {
        alert('No valid audio files selected. Please choose audio files.');
        message.style.display = 'block';
        playButton.disabled = true;
      } else if (playlist.length > 0) {
        message.style.display = 'none';
        playButton.disabled = false;
        if (isPlaying) {
          currentTrack = 0;
          batonHolder = 0;
          let player = document.getElementById('player');
          player.src = playlist[0].url;
          player.play().catch(handlePlaybackError);
        }
      } else {
        message.style.display = 'block';
        playButton.disabled = true;
      }
    }

    function updateRunners() {
      runners = [];
      let numRunners = playlist.length > 0 ? playlist.length : 0;
      for (let i = 0; i < numRunners; i++) {
        runners.push(new Runner(i * TWO_PI / numRunners, i));
      }
    }

    function togglePlayback() {
      let player = document.getElementById('player');
      if (isPlaying) {
        player.pause();
        isPlaying = false;
      } else if (playlist.length > 0) {
        player.src = playlist[currentTrack].url;
        player.play().catch(handlePlaybackError);
        isPlaying = true;
      }
    }

    function playNextTrack() {
      if (playlist.length === 0) return;
      currentTrack = (currentTrack + 1) % playlist.length;
      batonHolder = (batonHolder + 1) % runners.length;
      if (isPlaying) {
        let player = document.getElementById('player');
        player.src = playlist[currentTrack].url;
        player.play().catch(handlePlaybackError);
      }
    }

    function handlePlaybackError() {
      alert('Error playing audio file. Please ensure the file is valid and try again.');
      isPlaying = false;
      updateRunners();
      let message = document.getElementById('message');
      message.textContent = 'Playback error. Please select valid audio files.';
      message.style.display = 'block';
      document.getElementById('playPause').disabled = true;
    }
  </script>
</body>
</html>
