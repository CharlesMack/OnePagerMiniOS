<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P.O.P.S. ‚Äì Aurora Sanctuary (AppDrop)</title>
  <style>
    :root{
      --bg:#0b1020;
      --fg:#e8f6ff;
      --fg-dim:#c7d7e1;
      --glass:rgba(255,255,255,.08);
      --glass-2:rgba(255,255,255,.14);
      --accent:#67e8f9;
      --accent-2:#a78bfa;
      --accent-3:#34d399;
      --good:#34d399;
      --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--fg);
      background: radial-gradient(1200px 600px at 70% 20%, rgba(52,211,153,.25), transparent 60%),
                  radial-gradient(1000px 500px at 20% 10%, rgba(103,232,249,.20), transparent 60%),
                  radial-gradient(900px 400px at 40% 0%, rgba(167,139,250,.25), transparent 55%),
                  var(--bg);
      overflow:hidden;
    }

    /* Layout */
    #root{position:relative;height:100%;width:100%}
    canvas#aurora{position:absolute;inset:0;z-index:0;background:transparent}
    .veil{position:absolute;inset:0;backdrop-filter: blur(2px) brightness(1.05)}
    header{
      position:absolute;left:16px;right:16px;top:14px;z-index:3;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;padding:10px 12px 10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    header .title{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--glass-2);border:1px solid rgba(255,255,255,.18)}
    .title h1{margin:0;font-size:16px;letter-spacing:.4px}

    .controls{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    button, .btn{
      color:var(--fg);background:var(--glass);
      border:1px solid rgba(255,255,255,.18);padding:8px 12px;border-radius:12px;
      cursor:pointer;transition:transform .08s ease, background .2s ease, box-shadow .2s ease
    }
    button:hover{transform:translateY(-1px);background:var(--glass-2);box-shadow:0 6px 18px rgba(0,0,0,.3)}
    button.active{outline:2px solid var(--accent);background:rgba(103,232,249,.12)}

    /* Panel */
    .panel{
      position:absolute;left:16px;right:16px;bottom:16px;z-index:3;
      display:grid;grid-template-columns: 340px 1fr;gap:12px;min-height:220px;
    }
    .card{background:linear-gradient(180deg, rgba(9,12,24,.65), rgba(13,17,35,.55));
      border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:14px 14px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);min-height:200px
    }
    .card h2{margin:0 0 8px 0;font-size:14px;opacity:.9;letter-spacing:.35px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .slider{width:100%}

    /* Slideshow */
    #slideWrap{position:relative;height:100%;border-radius:14px;overflow:hidden}
    #slideWrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:14px;opacity:0;transition:opacity 1.2s ease}
    #slideWrap img.show{opacity:1}
    .dropzone{border:1px dashed rgba(255,255,255,.3);border-radius:14px;padding:8px;text-align:center;font-size:12px;opacity:.9}

    /* Relax coach */
    .breath{display:flex;flex-direction:column;gap:8px}
    .breath .viz{position:relative;height:130px;display:grid;place-items:center}
    .ring{width:130px;height:130px;border-radius:999px;border:2px solid rgba(255,255,255,.3);
      box-shadow:inset 0 0 30px rgba(52,211,153,.35), 0 0 30px rgba(52,211,153,.25);transition: all 2s ease}
    .ring.pulse{transform:scale(1.12);box-shadow:inset 0 0 40px rgba(52,211,153,.5), 0 0 40px rgba(52,211,153,.35)}
    .phase{position:absolute;bottom:8px;font-size:12px;letter-spacing:.3px;opacity:.9}

    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);cursor:pointer}
    .chip.active{outline:2px solid var(--accent-3);background:rgba(52,211,153,.12)}

    /* Content panes */
    .pane{display:none}
    .pane.active{display:block}

    .simple{font-size:13px;line-height:1.55;color:var(--fg-dim)}

    /* Caregiver (simple) mode */
    .caregiver .controls button{font-size:18px;padding:16px 18px;border-radius:16px}
    .caregiver .chips .chip{font-size:16px;padding:10px 14px}
    .caregiver .card h2{font-size:16px}

    /* Footer mini tips */
    .tips{position:absolute;right:16px;bottom:16px;font-size:11px;opacity:.7;z-index:4}
    .tips kbd{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);padding:.5px 5px;border-radius:6px}

    @media (max-width: 960px){
      .panel{grid-template-columns:1fr}
      .breath .viz{height:110px}
    }
  </style>
</head>
<body>
<div id="root" class="">
  <canvas id="aurora"></canvas>
  <div class="veil" aria-hidden="true"></div>

  <header>
    <div class="title">
      <span class="badge">AppDrop</span>
      <h1>üåå Aurora Sanctuary</h1>
      <span id="status" style="font-size:12px;opacity:.8"></span>
    </div>
    <div class="controls">
      <button id="modeRelax" class="active">Relaxation</button>
      <button id="modeSlide">Slideshow</button>
      <button id="modeExplore">Travel Guide</button>
      <button id="modeCulture">Culture & Myths</button>
      <button id="careBtn" title="Caregiver Mode">Caregiver</button>
    </div>
  </header>

  <section class="panel">
    <!-- LEFT CARD: Relaxation / Audio / Presets -->
    <div class="card" id="leftCard">
      <h2>Wellness Controls</h2>
      <div class="breath">
        <div class="viz">
          <div class="ring" id="ring"></div>
          <div class="phase" id="phase">ready</div>
        </div>
        <div class="chips" id="presetChips"></div>
        <div class="grid-2">
          <div class="row"><label>Pad Volume</label><input id="padVol" class="slider" type="range" min="0" max="1" step="0.01" value="0.35"></div>
          <div class="row"><label>Wind Volume</label><input id="windVol" class="slider" type="range" min="0" max="1" step="0.01" value="0.25"></div>
        </div>
        <div class="row">
          <button id="soundToggle">Start Sound</button>
          <button id="coachToggle">Start Coach</button>
        </div>
        <div class="simple">Presets modulate the canvas colors, breathing cadence, and soundscape mix to target use‚Äëcases like headache relief, focus, or sleep prep.</div>
      </div>
    </div>

    <!-- RIGHT CARD: Dynamic Pane -->
    <div class="card" id="rightCard">
      <div id="paneRelax" class="pane active">
        <h2>Relaxation Mode</h2>
        <div class="simple">Breathe with the ring. The aurora canvas adapts in color and tempo. Use <kbd>space</kbd> to pause/resume coach, <kbd>M</kbd> to mute, and <kbd>‚Üê/‚Üí</kbd> to switch modes.</div>
      </div>

      <div id="paneSlide" class="pane">
        <h2>Slideshow</h2>
        <div class="row" style="margin-bottom:8px">
          <button id="prev">Prev</button>
          <button id="next">Next</button>
          <label class="btn" for="filePick">Add Photos</label>
          <input id="filePick" type="file" accept="image/*" multiple style="display:none" />
          <span id="slideMeta" style="font-size:12px;opacity:.8"></span>
        </div>
        <div id="slideWrap">
          <div id="drop" class="dropzone">Drop aurora photos here ‚Ä¢ PNG/JPG/WebP</div>
        </div>
      </div>

      <div id="paneExplore" class="pane simple" style="max-height:58vh;overflow:auto">
        <h2>Best places to see the Northern Lights</h2>
        <ul>
          <li><strong>Troms√∏, Norway</strong> ‚Äì Gateway to the Arctic; strong aurora activity plus lively city ambience.</li>
          <li><strong>Swedish Lapland (Kiruna & Abisko)</strong> ‚Äì Dark skies; Abisko‚Äôs microclimate often means clearer nights.</li>
          <li><strong>Finnish Lapland (Levi, Kittil√§, Inari, Saariselk√§ & Rovaniemi)</strong> ‚Äì Family friendly in Rovaniemi; quieter in the north.</li>
          <li><strong>Iceland</strong> ‚Äì Dramatic volcano & glacier backdrops; pair with geothermal hot springs.</li>
          <li><strong>Alaska & Canadian North (Fairbanks, Yukon, Yellowknife, Churchill)</strong> ‚Äì Under the auroral oval with reliable displays.</li>
        </ul>
        <h2>Best time to go</h2>
        <ul>
          <li>Late September ‚Üí March (peak darkness). Equinox months (Mar/Sep) see increased geomagnetic activity.</li>
          <li>Choose new/crescent moon windows to avoid wash‚Äëout from a bright moon.</li>
        </ul>
        <h2>Unique ways to experience</h2>
        <ul>
          <li>Dog sledding, snowmobile safaris, reindeer sleighs</li>
          <li>Overnight glass igloos, aurora trains, roving dinners</li>
          <li>Hot‚Äëspring viewing, small‚Äëship cruises, minivan photo tours</li>
          <li>Hotel wake‚Äëup calls for sudden aurora bursts</li>
        </ul>
      </div>

      <div id="paneCulture" class="pane simple" style="max-height:58vh;overflow:auto">
        <h2>Cultural significance & legends</h2>
        <ul>
          <li><strong>Spirits of ancestors/animals</strong> dancing in the sky</li>
          <li><strong>Messages from the gods</strong> or bridges to the spirit world</li>
          <li><strong>Fire‚Äëfox</strong> (Finnish: <em>Revontulet</em>) sweeping its tail across the snow to spark the lights</li>
          <li><strong>Omens of change or fortune</strong> depending on local traditions</li>
        </ul>
        <p>Use this space as a gentle guided reading during sessions. Pair with low wind + soft pad for meditative ambience.</p>
      </div>
    </div>
  </section>

  <div class="tips">Shortcuts: <kbd>space</kbd> coach ‚Ä¢ <kbd>M</kbd> mute ‚Ä¢ <kbd>‚Üê/‚Üí</kbd> switch mode ‚Ä¢ <kbd>1-4</kbd> modes</div>
</div>

<script>
// ===== Assets =====
const FALLBACK_B64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQDxAQEA8QDw8PDw8QDw8PEA8PFBEQFREWFhURFRUYHCggGBolHRUVITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OGxAQGy0lHyYtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAMgAyAMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAEDBQYCB/EADkQAAEDAgQDBgUEAgIDAAAAAAEAAhEDIQQSMUEFIlFhBhMicYGRoRNCUrHB8CRCsvFDU+EkQ3OSYtL/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJhEBAAICAwEAAQQDAAAAAAAAAAECAxESITEEE0EiUWEUMnGBkf/aAAwDAQACEQMRAD8A2bXpc6r9j0ad1e5b3T2kHPl+Y+0Tqv1lI6z3tZ8nJH3YlQzYlN0PjU2c1S3sM+3nJm1yQ1u9y8L8j6bI2y4x2y8rU4VhB3h5Fq+6nY2uJtJx0v3v7m6f8A9vXxY3b3nZb2yR3mZbZQwT0wX2b2t+q5d5b1v8AqU1m+2v1F7b7+g1rJ9k2u1sQ2d6mY0h1OZ2w3x3m1rVb6m0l+5dQ3aY2oD9fHh7VvV3k8s9m+2fX2X2qfJ2a5q4v2n8qjzK2S1F2s1m6V5g2v2k8nqfZ5xZl2y0jG2WZtJrQm2d1fD7VnV7b1jV5eP3c6f6u+8b7V3m7j3m7j3n7kWwWb3n3b3m2k5XK5HLuYqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUgCkCqgAqgAoAFAFQAFABQAUAFABQAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAuQ1n0q1sNqS5fQ2mA6nF7T3eZ0rQ4b7m2fWavV7i8k6j2i2bV2aTWq7q7rZb+j0Gq7bW6m0VhWc6o8b2mQWbM8vSxq8b1uWn3VVLqfG5m6bX0d1Y2nZr1q1qF8fT4O0cGvYc8H8eQw6f6c+uWXzY+FfC4h9q1M8y7O6y6cWqT0uV1VxO8pJt0b7K3m1vE0f1PG1y2l1X1m5c7m2m+Xk5YvC2WmLkOQqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUAFAFQAUAFABQAUAFABQAUAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAuQ1n0q1sNqS5fQ2mA6nF7T3eZ0rQ4b7m2fWavV7i8k6j2i2bV2aTWq7q7rZb+j0Gq7bW6m0VhWc6o8b2mQWbM8vSxq8b1uWn3VVLqfG5m6bX0d1Y2nZr1q1qF8fT4O0cGvYc8H8eQw6f6c+uWXzY+FfC4h9q1M8y7O6y6cWqT0uV1VxO8pJt0b7K3m1vE0f1PG1y2l1X1m5c7m2m+Xk5YvC2WmLkOQqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUAFAFQAUAFABQAUAFABQAUAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAH/2Q=="; // injected below

// ===== State =====
const state = {
  mode: localStorage.getItem('aurora.mode') || 'relax',
  caregiver: localStorage.getItem('aurora.caregiver') === '1',
  slideshow: { idx: 0, dur: 7000, imgs: [FALLBACK_B64] },
  coach: { running:false, step:0, remain:0, preset:'Headache Relief' },
  audio: { ctx:null, started:false, padGain:0.35, windGain:0.25, muted:false },
  palette: 'green',
};

// ===== DOM =====
const q = sel => document.querySelector(sel);
const aurora = q('#aurora'); const ctx = aurora.getContext('2d');
const ring = q('#ring'); const phase = q('#phase');
const slideWrap = q('#slideWrap');
const statusEl = q('#status');

// ===== Resize =====
function fit(){ aurora.width = innerWidth * devicePixelRatio; aurora.height = innerHeight * devicePixelRatio; }
addEventListener('resize', fit); fit();

// ===== Aurora Painter =====
let t0 = performance.now();
function rand(min,max){return Math.random()*(max-min)+min}
function hsla(h,s,l,a){return `hsla(${h}, ${s}%, ${l}%, ${a})`}
let ribbons = [];
function initRibbons(){
  ribbons = new Array(6).fill(0).map((_,i)=>({
    baseY: rand(.25,.7)*aurora.height,
    amp: rand(40, 180)*devicePixelRatio,
    speed: rand(.00005,.00018),
    hue: (i*30 + (state.palette==='purple'?180: state.palette==='teal'?160:120))%360,
    alpha: rand(.05,.18),
    width: rand(30, 140)*devicePixelRatio,
  }));
}
initRibbons();

function paintAurora(ts){
  const t = (ts - t0);
  ctx.clearRect(0,0,aurora.width, aurora.height);
  ctx.globalCompositeOperation = 'lighter';

  // star field faint
  ctx.globalAlpha = .35; ctx.fillStyle = 'rgba(255,255,255,.02)';
  for(let i=0;i<60;i++){
    const x = (i*73*13 + (t*.02)) % aurora.width;
    const y = (i*97*29 % aurora.height);
    ctx.fillRect(x, y, 2, 2);
  }

  ribbons.forEach((r, idx)=>{
    const base = r.baseY + Math.sin(t * r.speed + idx) * r.amp;
    const grad = ctx.createLinearGradient(0, base - r.width, 0, base + r.width);
    grad.addColorStop(0, hsla(r.hue, 90, 65, 0));
    grad.addColorStop(.5, hsla(r.hue, 90, 65, r.alpha));
    grad.addColorStop(1, hsla((r.hue+40)%360, 90, 65, 0));

    ctx.fillStyle = grad;
    ctx.fillRect(0, base - r.width, aurora.width, r.width*2);
  });

  requestAnimationFrame(paintAurora);
}
requestAnimationFrame(paintAurora);

// ===== Breathing Coach =====
const PRESETS = [
  {name:'Headache Relief', palette:'green', cycle:[4,1,6], note:'Green emphasis, slow fade', pad:.35, wind:.25},
  {name:'Sleep Prep', palette:'teal', cycle:[4,7,8], note:'4-7-8 method', pad:.28, wind:.18},
  {name:'Deep Focus', palette:'purple', cycle:[5,0,5], note:'Box-lite 5-0-5', pad:.22, wind:.14},
  {name:'Uplift', palette:'emerald', cycle:[3,0,3], note:'Gentle energizer', pad:.40, wind:.22},
];

function renderChips(){
  const wrap = q('#presetChips'); wrap.innerHTML='';
  PRESETS.forEach(p=>{
    const el = document.createElement('div'); el.className='chip'+(state.coach.preset===p.name?' active':''); el.textContent=p.name; el.title=p.note;
    el.onclick=()=>applyPreset(p.name);
    wrap.appendChild(el);
  });
}
renderChips();

function applyPreset(name){
  const p = PRESETS.find(x=>x.name===name) || PRESETS[0];
  state.coach.preset = p.name; state.palette = p.palette;
  state.audio.padGain = p.pad; state.audio.windGain = p.wind; syncUI(); initRibbons();
}
applyPreset(state.coach.preset);

let coachTimer=null, coachIdx=0, coachPhase='ready';
function coachStart(){ if(state.coach.running) return; state.coach.running=true; coachIdx=0; tickCoach(); q('#coachToggle').textContent='Pause Coach'; }
function coachPause(){ state.coach.running=false; clearTimeout(coachTimer); q('#coachToggle').textContent='Start Coach'; phase.textContent='paused'; ring.classList.remove('pulse'); }
function tickCoach(){
  if(!state.coach.running) return;
  const p = PRESETS.find(x=>x.name===state.coach.preset) || PRESETS[0];
  const [inh, hold, ex] = p.cycle;
  const seq = [];
  if(inh>0) seq.push({label:'inhale', secs:inh});
  if(hold>0) seq.push({label:'hold', secs:hold});
  if(ex>0) seq.push({label:'exhale', secs:ex});
  const step = seq[coachIdx % seq.length];
  phase.textContent = step.label;
  ring.classList.toggle('pulse', step.label!=='hold');
  const ms = step.secs*1000;
  coachTimer = setTimeout(()=>{ coachIdx++; tickCoach(); }, ms);
}

// ===== Audio =====
let AC = window.AudioContext || window.webkitAudioContext;
function ensureAudio(){
  if(state.audio.ctx) return state.audio.ctx;
  const ctx = new AC();
  // pad (sine with slow tremolo)
  const pad = ctx.createOscillator(); pad.type='sine'; pad.frequency.value=160;
  const gain = ctx.createGain(); gain.gain.value = state.audio.padGain;
  const lfo = ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=.15;
  const lfoGain = ctx.createGain(); lfoGain.gain.value=.25; lfo.connect(lfoGain); lfoGain.connect(gain.gain);
  pad.connect(gain);

  // wind (noise through lowpass)
  const buffer = ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
  const data = buffer.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * .5 }
  const noise = ctx.createBufferSource(); noise.buffer=buffer; noise.loop=true;
  const low = ctx.createBiquadFilter(); low.type='lowpass'; low.frequency.value=1000;
  const windGain = ctx.createGain(); windGain.gain.value=state.audio.windGain;
  noise.connect(low).connect(windGain);

  const master = ctx.createGain(); master.gain.value = state.audio.muted?0:1;
  gain.connect(master); windGain.connect(master);
  master.connect(ctx.destination);

  // start
  pad.start(); lfo.start(); noise.start();
  state.audio.ctx = ctx; state.audio.master=master; state.audio.padGainNode=gain; state.audio.windGainNode=windGain;
  return ctx;
}

function startAudio(){ ensureAudio(); state.audio.started=true; q('#soundToggle').textContent = 'Mute'; status('sound on'); }
function toggleMute(){ if(!state.audio.ctx){ startAudio(); return } state.audio.muted = !state.audio.muted; state.audio.master.gain.value = state.audio.muted?0:1; q('#soundToggle').textContent = state.audio.muted? 'Unmute':'Mute'; status(state.audio.muted?'muted':'sound on'); }

// ===== Slideshow =====
let currentImg=null;
function showSlide(idx){
  const imgs = state.slideshow.imgs; if(imgs.length===0) return;
  state.slideshow.idx = (idx+imgs.length)%imgs.length;
  const src = imgs[state.slideshow.idx];
  if(!currentImg){ currentImg = document.createElement('img'); slideWrap.appendChild(currentImg); }
  const next = document.createElement('img'); next.src = src; slideWrap.appendChild(next);
  requestAnimationFrame(()=>{ if(currentImg) currentImg.classList.remove('show'); next.classList.add('show'); setTimeout(()=>{ if(currentImg && currentImg.parentNode) currentImg.parentNode.removeChild(currentImg); currentImg = next; }, 1200) })
  q('#slideMeta').textContent = `${state.slideshow.idx+1}/${imgs.length}`;
}
let slideTimer = null;
function autoPlay(){ clearInterval(slideTimer); slideTimer = setInterval(()=> showSlide(state.slideshow.idx+1), state.slideshow.dur) }

function handleFiles(files){
  for(const f of files){ if(!f.type.startsWith('image/')) continue; const url = URL.createObjectURL(f); state.slideshow.imgs.push(url) }
  if(state.slideshow.imgs.length>0) showSlide(state.slideshow.idx);
}

// drag-drop
const drop = q('#drop');
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='rgba(255,255,255,.06)'}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{e.preventDefault(); drop.style.background='transparent'}));
drop.addEventListener('drop', e=>{ e.preventDefault(); handleFiles(e.dataTransfer.files) });
q('#filePick').addEventListener('change', e=> handleFiles(e.target.files));

// ===== Modes =====
const panes = ['Relax','Slide','Explore','Culture'];
function setMode(m){
  state.mode = m; localStorage.setItem('aurora.mode', m);
  panes.forEach(name=>{ q('#pane'+name).classList.toggle('active', name.toLowerCase().startsWith(m)) })
  ;(['Relax','Slide','Explore','Culture']).forEach((name,i)=>{
    const id = ['#modeRelax','#modeSlide','#modeExplore','#modeCulture'][i];
    q(id).classList.toggle('active', name.toLowerCase().startsWith(m));
  })
  status(`mode: ${m}`);
}

// ===== Caregiver (simple) mode =====
function toggleCare(){
  state.caregiver = !state.caregiver; localStorage.setItem('aurora.caregiver', state.caregiver?'1':'0');
  document.getElementById('root').classList.toggle('caregiver', state.caregiver);
  q('#careBtn').classList.toggle('active', state.caregiver);
}

// ===== UI wiring =====
q('#modeRelax').onclick = ()=> setMode('relax');
q('#modeSlide').onclick = ()=> setMode('slide');
q('#modeExplore').onclick = ()=> setMode('explore');
q('#modeCulture').onclick = ()=> setMode('culture');
q('#careBtn').onclick = toggleCare;

q('#soundToggle').onclick = ()=>{ if(!state.audio.started) startAudio(); else toggleMute(); };
q('#padVol').oninput = e=>{ const v=+e.target.value; state.audio.padGain=v; if(state.audio.padGainNode) state.audio.padGainNode.gain.value=v };
q('#windVol').oninput = e=>{ const v=+e.target.value; state.audio.windGain=v; if(state.audio.windGainNode) state.audio.windGainNode.gain.value=v };
q('#coachToggle').onclick = ()=>{ state.coach.running?coachPause():coachStart() };
q('#prev').onclick = ()=> showSlide(state.slideshow.idx-1);
q('#next').onclick = ()=> showSlide(state.slideshow.idx+1);

function syncUI(){ q('#padVol').value=state.audio.padGain; q('#windVol').value=state.audio.windGain; renderChips(); }

function status(msg){ statusEl.textContent='‚Ä¢ '+msg; clearTimeout(status._t); status._t=setTimeout(()=>statusEl.textContent='', 2500) }

// Keyboard shortcuts
addEventListener('keydown', (e)=>{
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
  if(e.key===' '){ e.preventDefault(); state.coach.running?coachPause():coachStart(); }
  if(e.key==='m' || e.key==='M'){ e.preventDefault(); if(!state.audio.started) startAudio(); else toggleMute(); }
  if(e.key==='ArrowRight'){ setMode(nextMode(+1)) }
  if(e.key==='ArrowLeft'){ setMode(nextMode(-1)) }
  if(e.key==='1'){ setMode('relax') } if(e.key==='2'){ setMode('slide') } if(e.key==='3'){ setMode('explore') } if(e.key==='4'){ setMode('culture') }
});
function nextMode(d){ const order=['relax','slide','explore','culture']; let i=order.indexOf(state.mode); i=(i+d+order.length)%order.length; return order[i] }

// Initial
setMode(state.mode);
showSlide(0); autoPlay(); if(state.caregiver) toggleCare();

// Swap in real base64 (injected below)
</script>
<script>
  // Inject fallback image base64
  document.currentScript.previousElementSibling.textContent = document.currentScript.previousElementSibling.textContent.replace('/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQDxAQEA8QDw8PDw8QDw8PEA8PFBEQFREWFhURFRUYHCggGBolHRUVITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OGxAQGy0lHyYtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAMgAyAMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAEAAEDBQYCB/EADkQAAEDAgQDBgUEAgIDAAAAAAEAAhEDIQQSMUEFIlFhBhMicYGRoRNCUrHB8CRCsvFDU+EkQ3OSYtL/8QAGQEBAAMBAQAAAAAAAAAAAAAAAAECAwQF/8QAJhEBAAICAwEAAQQDAAAAAAAAAAECAxESITEEE0EiUWEUMnGBkf/aAAwDAQACEQMRAD8A2bXpc6r9j0ad1e5b3T2kHPl+Y+0Tqv1lI6z3tZ8nJH3YlQzYlN0PjU2c1S3sM+3nJm1yQ1u9y8L8j6bI2y4x2y8rU4VhB3h5Fq+6nY2uJtJx0v3v7m6f8A9vXxY3b3nZb2yR3mZbZQwT0wX2b2t+q5d5b1v8AqU1m+2v1F7b7+g1rJ9k2u1sQ2d6mY0h1OZ2w3x3m1rVb6m0l+5dQ3aY2oD9fHh7VvV3k8s9m+2fX2X2qfJ2a5q4v2n8qjzK2S1F2s1m6V5g2v2k8nqfZ5xZl2y0jG2WZtJrQm2d1fD7VnV7b1jV5eP3c6f6u+8b7V3m7j3m7j3n7kWwWb3n3b3m2k5XK5HLuYqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUgCkCqgAqgAoAFAFQAFABQAUAFABQAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAuQ1n0q1sNqS5fQ2mA6nF7T3eZ0rQ4b7m2fWavV7i8k6j2i2bV2aTWq7q7rZb+j0Gq7bW6m0VhWc6o8b2mQWbM8vSxq8b1uWn3VVLqfG5m6bX0d1Y2nZr1q1qF8fT4O0cGvYc8H8eQw6f6c+uWXzY+FfC4h9q1M8y7O6y6cWqT0uV1VxO8pJt0b7K3m1vE0f1PG1y2l1X1m5c7m2m+Xk5YvC2WmLkOQqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUAFAFQAUAFABQAUAFABQAUAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAuQ1n0q1sNqS5fQ2mA6nF7T3eZ0rQ4b7m2fWavV7i8k6j2i2bV2aTWq7q7rZb+j0Gq7bW6m0VhWc6o8b2mQWbM8vSxq8b1uWn3VVLqfG5m6bX0d1Y2nZr1q1qF8fT4O0cGvYc8H8eQw6f6c+uWXzY+FfC4h9q1M8y7O6y6cWqT0uV1VxO8pJt0b7K3m1vE0f1PG1y2l1X1m5c7m2m+Xk5YvC2WmLkOQqjKjUMUQwQxQ3oAIoACgAFAFQAFQAUABUABQAUAFAFQAUAFABQAUAFABQAUAFABUAFAFQAUAFABQAUAFABUAFABQAUAFABQAFABUAFACgAUAFAFQAUAFABQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAUAFAFQAUAFABQAUAFABQAUAFABQAH/2Q==', `${FALLBACK_B64.split(',')[1]}`);
</script>
</body>
</html>
