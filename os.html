<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1a1b23" />
  <title>P.O.P.S. — Modern Glassmorphism OS</title>
  <meta name="description" content="P.O.P.S. glassmorphism OS with mobile-first design, advanced panel management, and intuitive touch controls." />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0; 
      padding: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      overflow: hidden;
      height: 100vh;
      user-select: none;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Mobile-first HUD */
    #hud {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }

    #brand {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 18px;
    }

    .badge {
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }

    #actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
      color: white;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* Mobile menu toggle */
    .menu-toggle {
      display: none;
      flex-direction: column;
      gap: 3px;
      cursor: pointer;
      padding: 8px;
    }

    .menu-toggle span {
      width: 20px;
      height: 2px;
      background: white;
      border-radius: 1px;
      transition: all 0.3s ease;
    }

    .mobile-menu {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
      padding: 16px;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      z-index: 999;
    }

    .mobile-menu.active {
      transform: translateY(0);
    }

    .mobile-menu .btn {
      display: block;
      width: 100%;
      margin-bottom: 8px;
      text-align: left;
    }

    /* Panel System */
    .panel {
      position: absolute;
      width: min(90vw, 600px);
      min-width: 300px;
      min-height: 200px;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      resize: both;
      overflow: hidden;
      z-index: 1;
      display: flex;
      flex-direction: column;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .panel.active {
      z-index: 100;
      box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .panel.minimized {
      height: 50px !important;
      min-height: 50px;
      resize: none;
    }

    .panel.maximized {
      top: 60px !important;
      left: 0 !important;
      width: 100vw !important;
      height: calc(100vh - 120px) !important;
      border-radius: 0;
      resize: none;
    }

    .p-head {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 16px;
      font-weight: 600;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      touch-action: none;
    }

    .panel-title {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
    }

    .panel-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .panel-control {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .panel-control:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .minimize-btn { background: rgba(255, 193, 7, 0.3); }
    .maximize-btn { background: rgba(40, 167, 69, 0.3); }
    .close-btn { background: rgba(220, 53, 69, 0.3); }

    .p-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.02);
    }

    .p-body.hidden {
      display: none;
    }

    .urlbar {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .urlbar input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }

    .urlbar input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .urlbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      cursor: pointer;
      font-weight: 500;
    }

    iframe {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
    }

    .kv {
      display: flex;
      gap: 12px;
      margin: 12px 16px;
      align-items: center;
    }

    .kv span {
      min-width: 80px;
      font-weight: 500;
      font-size: 14px;
    }

    .kv input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
    }

    .list {
      background: rgba(255, 255, 255, 0.02);
      margin: 0 16px 16px 16px;
      border-radius: 12px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .appdrop {
      padding: 16px;
      margin: 8px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .appdrop:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .appdrop strong {
      display: block;
      margin-bottom: 4px;
      font-size: 16px;
    }

    .appdrop small {
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }

    /* Enhanced Dock */
    #dock {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #dock::-webkit-scrollbar {
      display: none;
    }

    .dock-item {
      background: rgba(255, 255, 255, 0.12);
      color: white;
      padding: 8px 16px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }

    .dock-item:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      #actions {
        display: none;
      }

      .menu-toggle {
        display: flex;
      }

      .panel {
        width: calc(100vw - 20px);
        left: 10px;
        min-width: calc(100vw - 20px);
      }

      .kv {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .kv span {
        min-width: auto;
      }

      .urlbar {
        flex-direction: column;
        gap: 8px;
      }

      .panel-controls {
        gap: 4px;
      }

      .panel-control {
        width: 32px;
        height: 32px;
      }
    }

    @media (max-width: 480px) {
      #hud {
        padding: 0 12px;
      }

      #brand {
        font-size: 16px;
      }

      .panel {
        width: calc(100vw - 16px);
        left: 8px;
        min-width: calc(100vw - 16px);
      }

      .dock-item {
        padding: 6px 12px;
        font-size: 13px;
      }
    }

    /* Touch enhancements */
    @media (hover: none) and (pointer: coarse) {
      .panel-control, .btn, .dock-item, .appdrop {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .panel-controls {
        gap: 8px;
      }
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .panel {
      animation: slideIn 0.3s ease;
    }

    /* Custom scrollbars */
    .list::-webkit-scrollbar {
      width: 4px;
    }

    .list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div id="hud">
    <div id="brand">
      <span>P.O.P.S.</span>
      <span class="badge">v2.0</span>
    </div>
    <div class="menu-toggle" onclick="toggleMobileMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div id="actions">
      <button class="btn" onclick="showBrowser()">🌐 Browser</button>
      <button class="btn" onclick="showCatalog()">📚 Catalog</button>
      <button class="btn" onclick="showInstaller()">💿 Install</button>
      <button class="btn" onclick="showPlugins()">🧩 Plugins</button>
      <button class="btn" onclick="showDocs()">📖 Docs</button>
      <button class="btn" onclick="saveLayout()">💾 Save</button>
      <button class="btn" onclick="loadLayout()">♻️ Load</button>
      <button class="btn" onclick="showZipBrowser()">🗂️ Files</button>
    </div>
  </div>

  <div class="mobile-menu" id="mobileMenu">
    <button class="btn" onclick="showBrowser(); toggleMobileMenu()">🌐 Web Browser</button>
    <button class="btn" onclick="showCatalog(); toggleMobileMenu()">📚 Catalog</button>
    <button class="btn" onclick="showInstaller(); toggleMobileMenu()">💿 Installer</button>
    <button class="btn" onclick="showPlugins(); toggleMobileMenu()">🧩 Plugins</button>
    <button class="btn" onclick="showDocs(); toggleMobileMenu()">📖 Documentation</button>
    <button class="btn" onclick="saveLayout(); toggleMobileMenu()">💾 Save Layout</button>
    <button class="btn" onclick="loadLayout(); toggleMobileMenu()">♻️ Load Layout</button>
    <button class="btn" onclick="showZipBrowser(); toggleMobileMenu()">🗂️ View Files</button>
  </div>

  <div id="dock"></div>
  <div id="panels"></div>
  <input type="file" id="zipUpload" style="display:none" accept=".zip" onchange="handleZipUpload(event)">

<script>
const panels = document.getElementById('panels');
const dock = document.getElementById('dock');
let panelCount = 0;
let currentDragPanel = null;
let dragOffset = { x: 0, y: 0 };

function toggleMobileMenu() {
  const menu = document.getElementById('mobileMenu');
  menu.classList.toggle('active');
}

function createPanel(title, contentHTML) {
  const panel = document.createElement('div');
  panel.className = 'panel';
  panel.id = `panel-${Date.now()}`;
  
  const isMobile = window.innerWidth <= 768;
  const offsetX = isMobile ? 10 : 100 + (panelCount * 20);
  const offsetY = isMobile ? 80 + (panelCount * 10) : 100 + (panelCount * 20);
  
  panel.style.left = `${offsetX}px`;
  panel.style.top = `${offsetY}px`;
  
  panel.innerHTML = `
    <div class="p-head" onmousedown="startDrag(event, this.parentElement)" ontouchstart="startDrag(event, this.parentElement)">
      <div class="panel-title">${title}</div>
      <div class="panel-controls">
        <button class="panel-control minimize-btn" onclick="minimizePanel(this.closest('.panel'))" title="Minimize">−</button>
        <button class="panel-control maximize-btn" onclick="maximizePanel(this.closest('.panel'))" title="Maximize">□</button>
        <button class="panel-control close-btn" onclick="closePanel(this.closest('.panel'))" title="Close">×</button>
      </div>
    </div>
    <div class="p-body">${contentHTML}</div>`;
  
  panels.appendChild(panel);
  bringToFront(panel);
  panelCount++;
  return panel;
}

function bringToFront(panel) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  panel.style.zIndex = Date.now();
  panel.classList.add('active');
}

function minimizePanel(panel) {
  if (panel.classList.contains('minimized')) {
    panel.classList.remove('minimized');
    panel.querySelector('.p-body').classList.remove('hidden');
    panel.querySelector('.minimize-btn').textContent = '−';
  } else {
    panel.classList.add('minimized');
    panel.querySelector('.p-body').classList.add('hidden');
    panel.querySelector('.minimize-btn').textContent = '+';
  }
}

function maximizePanel(panel) {
  if (panel.classList.contains('maximized')) {
    panel.classList.remove('maximized');
    panel.querySelector('.maximize-btn').textContent = '□';
  } else {
    panel.classList.add('maximized');
    panel.querySelector('.maximize-btn').textContent = '⧉';
    bringToFront(panel);
  }
}

function closePanel(panel) {
  panel.style.transform = 'scale(0.8)';
  panel.style.opacity = '0';
  setTimeout(() => {
    panel.remove();
  }, 200);
}

function startDrag(evt, panel) {
  evt.preventDefault();
  bringToFront(panel);
  
  if (panel.classList.contains('maximized')) return;
  
  const isTouch = evt.type === 'touchstart';
  const clientX = isTouch ? evt.touches[0].clientX : evt.clientX;
  const clientY = isTouch ? evt.touches[0].clientY : evt.clientY;
  
  const rect = panel.getBoundingClientRect();
  dragOffset.x = clientX - rect.left;
  dragOffset.y = clientY - rect.top;
  currentDragPanel = panel;
  
  const moveEvent = isTouch ? 'touchmove' : 'mousemove';
  const endEvent = isTouch ? 'touchend' : 'mouseup';
  
  function onMove(e) {
    if (!currentDragPanel) return;
    
    const moveX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX) - dragOffset.x;
    const moveY = (e.type === 'touchmove' ? e.touches[0].clientY : e.clientY) - dragOffset.y;
    
    const maxX = window.innerWidth - currentDragPanel.offsetWidth;
    const maxY = window.innerHeight - currentDragPanel.offsetHeight - 60;
    
    currentDragPanel.style.left = `${Math.max(0, Math.min(maxX, moveX))}px`;
    currentDragPanel.style.top = `${Math.max(60, Math.min(maxY, moveY))}px`;
  }
  
  function onEnd() {
    currentDragPanel = null;
    document.removeEventListener(moveEvent, onMove);
    document.removeEventListener(endEvent, onEnd);
  }
  
  document.addEventListener(moveEvent, onMove, { passive: false });
  document.addEventListener(endEvent, onEnd);
}

function showBrowser() {
  const html = `
    <div class="urlbar">
      <input type="text" value="https://charlesmack.github.io/pops-media-hub/" id="urlInput" placeholder="Enter URL...">
      <button onclick="goToURL()">Go</button>
    </div>
    <iframe id="webFrame" src="https://charlesmack.github.io/pops-media-hub/"></iframe>`;
  createPanel("🌐 Web Browser", html);
}

function goToURL() {
  const url = document.getElementById('urlInput').value;
  if (url && !url.startsWith('http')) {
    document.getElementById('urlInput').value = 'https://' + url;
  }
  document.getElementById('webFrame').src = document.getElementById('urlInput').value;
}

function showCatalog() {
  const html = `
    <div class="kv">
      <span>Filter</span>
      <input id="catFilter" type="text" oninput="filterCatalog()" placeholder="Search AppDrops..." />
    </div>
    <div class="list" id="catalogList"></div>`;
  createPanel("📚 App Catalog", html);
  loadCatalog();
}

function filterCatalog() {
  const term = document.getElementById('catFilter').value.toLowerCase();
  document.querySelectorAll('.appdrop').forEach(el => {
    el.style.display = el.innerText.toLowerCase().includes(term) ? 'block' : 'none';
  });
}

function loadCatalog() {
  const list = [
   { name: "P.O.P.S. Media Hub", version: "0.3.2", entry: "appdrops/pops/index.html", type: "iframe", description: "AI-driven music, video & art hub with leaderboard and voice control." },
    { name: "Offline Encyclopedia", version: "1.0.0", entry: "appdrops/encyclopedia/index.html", type: "iframe", description: "Browse curated offline articles, guides, and resources." },
    { name: "Survivor’s Compass", entry: "appdrops/survivors-compass/index.html", description: "Offline Navigation + Survival Toolkit AppDrop" },
    { name: "🎵 3D Media Player World", entry: "../3d-media-player-world", description: "A web-based 3D interactive concert and media player experience." },
    { name: "First Aid Quick-Reference", entry: "appdrops/first-aid-quickref/index.html", description: "First Aid quick-reference mini" },
    { name: "First Aid Guide", version: "1.0.0", entry: "appdrops/firstaid/index.html", type: "iframe", description: "Offline emergency and medical first aid reference app." },
    { name: "Offline World Atlas", entry: "appdrops/atlas/index.html", type: "iframe", description: "Explore maps and geographic data offline." },
    { name: "Scratchpad", entry: "appdrops/scratchpad/index.html", type: "iframe", description: "Quick notes and ideas, stored offline." },
    { name: "Planner Lite", entry: "appdrops/planner-lite/index.html", description: "Simple task & schedule tracker" },
    { name: "Planner Lite + (Gemini-Powered)", entry: "appdrops/planner-gemini/index.html", type: "iframe", description: "Simple Gemini-Powered calendar and task manager Planner Lite + (Api-key optional)." }, 
    { name: "Minor Glitch + (Charles Standby)", entry: "appdrops/charles5-p/index.html", type: "iframe", description: " Charles 5 — Procedural Wave Spin Speak." }, 
    { name: "Minor Glitch (World Mode) ", entry: "appdrops/charles5-w/index.html", description: " P.O.P.S. Charles 5 — World Mode First‑Person Third‑Person Manual Auto Focus Tired Sunbathe Dance" },
    { name: "Minor Glitch (Play w/ Max) ", entry: "appdrops/charles5-m/index.html", description: "P.O.P.S. C5 + Max — Offline 👁️ FP 🎥 TP 🕹️ Manual 🤖 Auto 🎯 Focus 😴 Tired 🔆 Sunbathe 💃 Dance 🪩 Theater On/Off 🍖 Drop Treat 🧑‍🔧 Feed Max 🥎 Fetch!" },
    { name: "Minor Glitch (Max Sidekick) ", entry: "appdrops/charles5-s/index.html", description: "P.O.P.S. Legacy System" },
    { name: "Minor Glitch (Max Fetch Ball) ", entry: "appdrops/charles5-sf/index.html", description: "P.O.P.S. Legacy System Fetch" },
    { name: "Fiveseconds Video", entry: "appdrops/fiveseconds-lite/index.html", type: "iframe", description: "Simple Point & shoot Camera 5 sec video recorder Lite +." }, 
    { name: "Fiveseconds Video + (Cinema- AI Powered Focus)", entry: "appdrops/fiveseconds-cine/index.html", type: "iframe", description: "Simple AI-Powered cinematic focusing panning zooming 5 second video recorder Lite + (AI)." }, 
    { name: "Fiveseconds Video + (Cinema- AI Powered Focus)", entry: "appdrops/fiveseconds-cine/index.html", type: "iframe", description: "Simple AI-Powered cinematic focusing panning zooming 5 second video recorder Lite + (AI)." }, 
    { name: "Aurora  + (Relaxation- AI Powered Focus)", entry: "appdrops/fiveseconds-cine/index.html", type: "iframe", description: "Simple AI-Powered cinematic focusing panning zooming 5 second video recorder Lite + (AI)." }, 
    { name: "Hearsay Audio Recorder", entry: "appdrops/hearsay/index.html", description: "Record, Replay, Save, Download" },
    { name: "Hearsay Cinema", entry: "appdrops/hearsay-cinema/index.html", description: " MP4/WebM player with playlist, A-B loop, visualizer" },
    { name: "Image Viewer", entry: "appdrops/image-viewer/index.html", type: "iframe", description: "Browse and preview offline images." },
    { name: "Viewria", entry: "appdrops/viewria/index.html", description: "Movie Video player" },
    { name: "Hobit", entry: "appdrops/dev-editor/index.html", description: "Dev Tools — HTML/JS Editor & Previewer" },
    { name: "Reader Pro", entry: "appdrops/readerpro/index.html", description: "Ebook PDF Reader" },
    { name: "Dev Editor", entry: "appdrops/dev-editor/index.html", description: "offline‑first editor with HTML/JS/CSS tabs, a live preview pane +" },
    { name: "Procedural Art", entry: "appdrops/proc-art/index.html", type: "iframe", description: "Generate creative visuals using code." },
    { name: "Slangtionary Lite", entry: "appdrops/slangtionary/index.html", type: "iframe", description: "Offline urban dictionary for fun definitions." },
    { name: "Panel Pong", entry: "appdrops/panel-pong/index.html", description: "Classic pong in panel" }
  ];
  
  const catList = document.getElementById('catalogList');
  catList.innerHTML = '';
  
  for (const app of list) {
    const div = document.createElement('div');
    div.className = 'appdrop';
    div.setAttribute('data-url', app.entry);
    div.innerHTML = `
      <strong>${app.name}</strong>
      <small>${app.description}</small>`;
    div.onclick = () => launchAppDrop(app.entry, app.name);
    catList.appendChild(div);
  }
}

function launchAppDrop(url, title) {
  const html = `<iframe src="${url}"></iframe>`;
  createPanel(title, html);
  dockItem(title, () => launchAppDrop(url, title));
}

function showInstaller() {
  document.getElementById('zipUpload').click();
}

async function handleZipUpload(event) {
  const file = event.target.files[0];
  if (!file || !file.name.endsWith('.zip')) {
    alert('Please select a valid ZIP file.');
    return;
  }
  
  try {
    const zip = await JSZip.loadAsync(file);
    const files = Object.keys(zip.files);
    const db = await openAppDropDB();
    const tx = db.transaction('apps', 'readwrite');
    const store = tx.objectStore('apps');
    
    for (const path of files) {
      if (!zip.files[path].dir) {
        const content = await zip.files[path].async('string');
        await store.put({ path, content });
      }
    }
    
    alert(`Successfully installed ${files.filter(f => !zip.files[f].dir).length} files from ${file.name}`);
  } catch (error) {
    alert('Error installing ZIP file: ' + error.message);
  }
}

async function openAppDropDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('AppDropStorage', 1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('apps')) {
        db.createObjectStore('apps', { keyPath: 'path' });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

async function showZipBrowser() {
  try {
    const db = await openAppDropDB();
    const tx = db.transaction('apps', 'readonly');
    const store = tx.objectStore('apps');
    const req = store.getAll();
    
    req.onsuccess = () => {
      const files = req.result;
      const html = `
        <div style="padding: 16px;">
          <h3 style="margin-top: 0;">Installed Files (${files.length})</h3>
          <div class="list">
            ${files.length > 0 
              ? files.map(f => `<div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">${f.path}</div>`).join('')
              : '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">No files installed</div>'
            }
          </div>
        </div>`;
      createPanel("🗂️ File Browser", html);
    };
  } catch (error) {
    alert('Error accessing file storage: ' + error.message);
  }
}

function showPlugins() {
  const html = `
    <div style="padding: 16px;">
      <div class="kv">
        <span>Plugin:</span>
        <input placeholder="Enter plugin name or URL..." />
      </div>
      <div class="list">
        <div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.6);">
          Plugin system coming soon...<br><br>
          <small>Future support for custom widgets, themes, and extensions</small>
        </div>
      </div>
    </div>`;
  createPanel("🧩 Plugin Manager", html);
}

function showDocs() {
  const html = `
    <div style="padding: 20px; line-height: 1.6;">
      <h2 style="margin-top: 0; color: #fff;">Welcome to P.O.P.S. OS v2.0</h2>
      
      <h3>✨ New Features</h3>
      <p>• Modern glassmorphism design with blur effects<br>
      • Mobile-first responsive interface<br>
      • Enhanced panel controls (minimize, maximize)<br>
      • Touch-friendly drag and drop<br>
      • Improved accessibility</p>
      
      <h3>🎮 Controls</h3>
      <p>• <strong>Drag:</strong> Click and hold panel header<br>
      • <strong>Resize:</strong> Drag from bottom-right corner<br>
      • <strong>Minimize:</strong> Yellow button (−)<br>
      • <strong>Maximize:</strong> Green button (□)<br>
      • <strong>Close:</strong> Red button (×)</p>
      
      <h3>💾 Storage</h3>
      <p>Your layouts and installed apps are saved locally. Use Save/Load to manage your workspace configuration.</p>
    </div>`;
  createPanel("📖 Documentation", html);
}

function dockItem(label, action) {
  // Check if item already exists
  const existing = Array.from(dock.children).find(item => item.textContent === label);
  if (existing) return;
  
  const btn = document.createElement('div');
  btn.className = 'dock-item';
  btn.textContent = label;
  btn.onclick = action;
  dock.appendChild(btn);
}

function saveLayout() {
  const data = [];
  document.querySelectorAll('.panel').forEach(p => {
    const title = p.querySelector('.panel-title').textContent;
    const body = p.querySelector('.p-body');
    data.push({
      title: title,
      content: body.innerHTML,
      top: p.style.top,
      left: p.style.left,
      width: p.style.width,
      height: p.style.height,
      minimized: p.classList.contains('minimized'),
      maximized: p.classList.contains('maximized')
    });
  });
  
  // Save dock items
  const dockItems = Array.from(dock.children).map(item => ({
    label: item.textContent,
    action: item.onclick ? item.onclick.toString() : null
  }));
  
  const layoutData = {
    panels: data,
    dock: dockItems,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('popsLayout', JSON.stringify(layoutData));
  
  // Show success notification
  showNotification('💾 Layout saved successfully!', 'success');
}

function loadLayout() {
  const savedData = localStorage.getItem('popsLayout');
  if (!savedData) {
    showNotification('❌ No saved layout found', 'error');
    return;
  }
  
  try {
    const layoutData = JSON.parse(savedData);
    
    // Clear current panels
    document.querySelectorAll('.panel').forEach(p => p.remove());
    dock.innerHTML = '';
    
    // Restore panels
    for (const p of layoutData.panels || []) {
      const panel = createPanel(p.title, p.content);
      if (p.top) panel.style.top = p.top;
      if (p.left) panel.style.left = p.left;
      if (p.width) panel.style.width = p.width;
      if (p.height) panel.style.height = p.height;
      
      if (p.minimized) {
        panel.classList.add('minimized');
        panel.querySelector('.p-body').classList.add('hidden');
        panel.querySelector('.minimize-btn').textContent = '+';
      }
      
      if (p.maximized) {
        panel.classList.add('maximized');
        panel.querySelector('.maximize-btn').textContent = '⧉';
      }
    }
    
    // Restore dock items
    for (const item of layoutData.dock || []) {
      if (item.label && item.action) {
        try {
          const actionFunc = eval('(' + item.action + ')');
          dockItem(item.label, actionFunc);
        } catch (e) {
          // Skip invalid actions
        }
      }
    }
    
    showNotification('♻️ Layout loaded successfully!', 'success');
  } catch (error) {
    showNotification('❌ Error loading layout: ' + error.message, 'error');
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${type === 'success' ? 'rgba(40, 167, 69, 0.9)' : type === 'error' ? 'rgba(220, 53, 69, 0.9)' : 'rgba(0, 123, 255, 0.9)'};
    backdrop-filter: blur(20px);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: 500;
    font-size: 14px;
    z-index: 10000;
    animation: slideIn 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100px)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Touch and mobile enhancements
let touchStartTime = 0;
let touchStartPos = { x: 0, y: 0 };

document.addEventListener('touchstart', (e) => {
  touchStartTime = Date.now();
  if (e.touches.length === 1) {
    touchStartPos.x = e.touches[0].clientX;
    touchStartPos.y = e.touches[0].clientY;
  }
});

document.addEventListener('touchend', (e) => {
  const touchDuration = Date.now() - touchStartTime;
  const touchEndPos = e.changedTouches[0];
  const distance = Math.sqrt(
    Math.pow(touchEndPos.clientX - touchStartPos.x, 2) + 
    Math.pow(touchEndPos.clientY - touchStartPos.y, 2)
  );
  
  // Close mobile menu on tap outside
  if (touchDuration < 300 && distance < 10) {
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenu.classList.contains('active') && !e.target.closest('#mobileMenu') && !e.target.closest('.menu-toggle')) {
      mobileMenu.classList.remove('active');
    }
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch (e.key) {
      case 's':
        e.preventDefault();
        saveLayout();
        break;
      case 'o':
        e.preventDefault();
        loadLayout();
        break;
      case 'n':
        e.preventDefault();
        showBrowser();
        break;
      case 'Escape':
        // Close active panel
        const activePanel = document.querySelector('.panel.active');
        if (activePanel) {
          closePanel(activePanel);
        }
        break;
    }
  }
});

// Auto-resize panels on window resize
window.addEventListener('resize', () => {
  document.querySelectorAll('.panel').forEach(panel => {
    const rect = panel.getBoundingClientRect();
    const maxX = window.innerWidth - panel.offsetWidth;
    const maxY = window.innerHeight - panel.offsetHeight - 60;
    
    if (rect.left > maxX) {
      panel.style.left = Math.max(0, maxX) + 'px';
    }
    if (rect.top > maxY) {
      panel.style.top = Math.max(60, maxY) + 'px';
    }
  });
});

// Initialize with welcome panel on first load
window.addEventListener('load', () => {
  const hasVisited = localStorage.getItem('popsFirstVisit');
  if (!hasVisited) {
    setTimeout(() => {
      showDocs();
      localStorage.setItem('popsFirstVisit', 'true');
    }, 500);
  }
});

// Service worker registration for PWA support (optional)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
</script>

</body>
</html>
