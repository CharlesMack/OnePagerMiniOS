<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.O.P.S. OS Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/shaders/VignetteShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
    <style>
        :root {
            --taskbar-height: 40px;
            --start-menu-width: 250px;
            --border-radius: 8px;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --text-color: #f0f0f0;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }

        #webgl-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        #desktop {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-content: flex-start;
        }

        .icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            margin: 15px;
            padding: 5px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            position: relative;
            z-index: 1;
        }

        .icon:hover, .fs-item.drop-hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .icon .icon-image {
            font-size: 32px;
            text-shadow: 2px 2px 4px var(--shadow-color);
            transition: transform 0.2s ease;
        }

        .icon:hover .icon-image {
            transform: scale(1.2);
        }

        .icon span, .fs-item span {
            margin-top: 8px;
            font-size: 13px;
            text-shadow: 1px 1px 2px var(--shadow-color);
            word-break: break-all;
        }
        
        .icon input[type="text"] {
            width: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            font-size: 12px;
            text-align: center;
            padding: 2px;
            margin-top: 8px;
        }

        .window {
            position: absolute;
            min-width: 250px;
            min-height: 150px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            transition: none;
        }

        .window.minimized {
            transform: scale(0.8) translateY(200px);
            opacity: 0;
            pointer-events: none;
        }

        .title-bar {
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            padding: 8px 12px;
            cursor: move;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .title-bar-buttons {
            display: flex;
            gap: 8px;
        }

        .title-bar-buttons button {
            background: transparent;
            color: var(--text-color);
            border: none;
            font-weight: bold;
            font-size: 16px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .title-bar-buttons .minimize:hover { background-color: #575757; }
        .title-bar-buttons .maximize:hover { background-color: #575757; }
        .title-bar-buttons .close:hover { background-color: #e81123; }

        .window-content {
            padding: 10px;
            flex-grow: 1;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--taskbar-height);
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 5px;
            box-sizing: border-box;
            z-index: 10000;
        }

        #start-button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            padding: 0 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        #start-button:hover { background-color: rgba(255, 255, 255, 0.2); }

        #taskbar-apps {
            display: flex;
            height: 100%;
            margin-left: 10px;
        }

        .taskbar-item {
            background-color: rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid transparent;
            color: var(--text-color);
            padding: 0 15px;
            margin: 5px 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .taskbar-item:hover { background-color: rgba(255, 255, 255, 0.2); }
        .taskbar-item.active {
            background-color: rgba(255, 255, 255, 0.25);
            border-bottom: 2px solid #6cbeff;
        }

        #clock {
            margin-left: auto;
            padding-right: 15px;
            font-size: 13px;
            text-align: center;
        }

        #start-menu {
            position: absolute;
            bottom: var(--taskbar-height);
            left: 0;
            width: var(--start-menu-width);
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border: var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            padding: 10px;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s ease;
        }

        #start-menu.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        #start-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #start-menu li {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        #start-menu li:hover { background-color: rgba(255, 255, 255, 0.2); }

        #context-menu, .file-context-menu {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 16px var(--shadow-color);
            padding: 8px;
            z-index: 10001;
            display: none;
        }

        #context-menu ul, .file-context-menu ul { list-style: none; padding: 0; margin: 0; }
        #context-menu li, .file-context-menu li { padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 14px; }
        #context-menu li:hover, .file-context-menu li:hover { background-color: rgba(255, 255, 255, 0.2); }
        #context-menu hr, .file-context-menu hr { border: none; border-top: var(--glass-border); margin: 5px 0; }

        #snap-preview {
            position: absolute;
            background: rgba(100, 150, 255, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            z-index: 9998;
            display: none;
            transition: all 0.1s ease-out;
        }

        .notepad-toolbar {
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .notepad-toolbar button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            padding: 5px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .notepad-toolbar button:hover { background: rgba(255, 255, 255, 0.3); }
        .notepad-toolbar button:active { background: rgba(255, 255, 255, 0.4); }

        .notepad-textarea {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-family: Consolas, 'Courier New', monospace;
            font-size: 14px;
            resize: none;
        }
        .notepad-textarea:focus { outline: none; }

        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100%; }
        .calculator-grid button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calculator-grid button:hover { background: rgba(255, 255, 255, 0.3); }
        .calculator-grid button:active { background: rgba(255, 255, 255, 0.4); }
        .calculator-display {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.3);
            font-size: 28px;
            padding: 10px;
            text-align: right;
            border-radius: 4px;
            word-wrap: break-word;
            min-height: 40px;
        }
        .operator { background-color: rgba(255, 159, 64, 0.4) !important; }
        .span-two { grid-column: span 2; }

        .file-manager { display: flex; height: 100%; }
        .sidebar { width: 120px; border-right: var(--glass-border); padding: 5px; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 10px; display: flex; flex-wrap: wrap; align-content: flex-start; }
        .fs-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 70px;
            margin: 10px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }
        .fs-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }
        .fs-item .icon-image { font-size: 32px; }
        .fs-item input[type="text"] {
            width: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            font-size: 12px;
            text-align: center;
            padding: 2px;
            display: none;
        }
        .fs-item input[type="text"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            padding: 15px;
            height: 100%;
            align-items: center;
        }
        .settings-grid label {
            font-size: 14px;
            font-weight: bold;
        }
        .settings-grid select,
        .settings-grid input[type="range"] {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            padding: 5px;
            width: 100%;
            cursor: pointer;
        }
        .settings-grid select:focus,
        .settings-grid input[type="range"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }
        .settings-grid input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
        }
        .settings-grid input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--text-color);
            border-radius: 50%;
            cursor: pointer;
        }

        @media (prefers-reduced-motion: reduce) {
            .window, .icon .icon-image, .fs-item, .notepad-toolbar button {
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <canvas id="webgl-canvas"></canvas>
    <div id="desktop">
        <!-- Desktop icons will be rendered here dynamically -->
    </div>
    <div id="snap-preview"></div>
    <div id="context-menu">
        <!-- Desktop context menu content will be rendered here dynamically -->
    </div>
    <div class="taskbar">
        <button id="start-button">🚀</button>
        <div id="taskbar-apps"></div>
        <div id="clock"></div>
    </div>
    <div id="start-menu">
        <ul>
            <li onclick="appManager.open('about')">ℹ️ About</li>
            <li onclick="appManager.open('notepad')">📝 Notepad</li>
            <li onclick="appManager.open('calculator')">🧮 Calculator</li>
            <li onclick="appManager.open('filemanager')">📁 File Manager</li>
            <li onclick="appManager.open('settings')">⚙️ Settings</li>
        </ul>
    </div>

    <script>
        // --- FileSystem Class ---
        class FileSystem {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.fs = this.stateManager.state.filesystem || {
                    '/': {
                        type: 'folder',
                        children: {
                            'Desktop': {
                                type: 'folder',
                                children: {
                                    'Welcome.txt': { type: 'file', content: 'Welcome to P.O.P.S. OS!' },
                                    'Notes.txt': { type: 'file', content: 'Write your notes here.' }
                                }
                            },
                            'Documents': {
                                type: 'folder',
                                children: {
                                    'Project.txt': { type: 'file', content: 'Project notes' }
                                }
                            },
                            'Pictures': {
                                type: 'folder',
                                children: {
                                    'Holiday.jpg': { type: 'file', content: 'Image placeholder' }
                                }
                            }
                        }
                    }
                };
                this.save();
            }

            save() {
                this.stateManager.state.filesystem = this.fs;
                this.stateManager.save();
            }

            getPath(path) {
                const parts = path.split('/').filter(p => p);
                let current = this.fs['/'];
                for (const part of parts) {
                    if (!current.children || !current.children[part]) return null;
                    current = current.children[part];
                }
                return current;
            }

            createItem(parentPath, name, type, content = '') {
                const parent = this.getPath(parentPath);
                if (!parent || parent.type !== 'folder') return false;
                if (!parent.children) parent.children = {};
                if (parent.children[name]) return false;
                parent.children[name] = { type, content: type === 'file' ? content : {} };
                this.save();
                return true;
            }

            renameItem(path, newName) {
                const parts = path.split('/').filter(p => p);
                const name = parts.pop();
                const parentPath = '/' + parts.join('/');
                const parent = this.getPath(parentPath);
                if (!parent || !parent.children || !parent.children[name]) return false;
                if (parent.children[newName]) return false;
                parent.children[newName] = parent.children[name];
                delete parent.children[name];
                this.save();
                return true;
            }

            deleteItem(path) {
                const parts = path.split('/').filter(p => p);
                const name = parts.pop();
                const parentPath = '/' + parts.join('/');
                const parent = this.getPath(parentPath);
                if (!parent || !parent.children || !parent.children[name]) return false;
                delete parent.children[name];
                this.save();
                return true;
            }
            
            moveItem(sourcePath, destPath) {
                const sourceParts = sourcePath.split('/').filter(p => p);
                const sourceName = sourceParts.pop();
                const sourceParentPath = '/' + sourceParts.join('/');
                const sourceParent = this.getPath(sourceParentPath);

                const destParent = this.getPath(destPath);

                if (!sourceParent || !sourceParent.children || !sourceParent.children[sourceName] || !destParent || destParent.type !== 'folder') {
                    return false;
                }
                if (destParent.children && destParent.children[sourceName]) {
                    return false; // Name conflict
                }
                if (!destParent.children) destParent.children = {};

                destParent.children[sourceName] = sourceParent.children[sourceName];
                delete sourceParent.children[sourceName];
                this.save();
                return true;
            }

            updateFileContent(path, content) {
                const file = this.getPath(path);
                if (!file || file.type !== 'file') return false;
                file.content = content;
                this.save();
                return true;
            }

            listItems(path) {
                const node = this.getPath(path);
                if (!node || node.type !== 'folder' || !node.children) return [];
                return Object.entries(node.children).map(([name, data]) => ({
                    name,
                    type: data.type,
                    path: `${path === '/' ? '' : path}/${name}`,
                    content: data.content
                }));
            }
        }

        // --- Sound Manager ---
        class SoundManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.currentSound = null;
            }

            playSound(type) {
                if (!this.stateManager.state.settings.soundsEnabled || window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
                if (this.currentSound) {
                    this.currentSound.stop();
                }

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                let frequency, duration;
                switch (type) {
                    case 'open': frequency = 440; duration = 0.15; break;
                    case 'close': frequency = 220; duration = 0.1; break;
                    case 'minimize': frequency = 330; duration = 0.12; break;
                    case 'maximize': frequency = 550; duration = 0.15; break;
                    case 'click': frequency = 660; duration = 0.08; break;
                    case 'create': frequency = 500; duration = 0.1; break;
                    case 'delete': frequency = 200; duration = 0.1; break;
                    case 'save': frequency = 600; duration = 0.12; break;
                    case 'drop': frequency = 300; duration = 0.1; break;
                    default: return;
                }

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + duration);
                this.currentSound = oscillator;
            }
        }

        // --- ECS Architecture ---
        class ECS {
            constructor() {
                this.entities = new Map();
                this.systems = [];
                this.nextId = 0;
            }

            createEntity() {
                const id = `entity-${this.nextId++}`;
                this.entities.set(id, { components: new Map() });
                return id;
            }

            addComponent(entityId, component, data) {
                this.entities.get(entityId).components.set(component, data);
            }

            getComponent(entityId, component) {
                return this.entities.get(entityId).components.get(component);
            }

            addSystem(system) {
                this.systems.push(system);
            }

            update() {
                this.systems.forEach(system => system.update(this));
            }
        }

        // --- State Manager ---
        class StateManager {
            constructor() {
                this.state = {
                    windows: {},
                    filesystem: null,
                    settings: {
                        quality: 'high',
                        bloomIntensity: 0.7,
                        vignetteDarkness: 1.0,
                        animationsEnabled: true,
                        soundsEnabled: true
                    }
                };
                this.load();
            }

            save() {
                localStorage.setItem('popsOS', JSON.stringify(this.state));
            }

            load() {
                const saved = localStorage.getItem('popsOS');
                if (saved) this.state = JSON.parse(saved);
            }

            setWindowState(id, state) { this.state.windows[id] = state; this.save(); }
            getWindowState(id) { return this.state.windows[id] || {}; }
            setQuality(quality) { this.state.settings.quality = quality; this.save(); }
            setBloomIntensity(intensity) { this.state.settings.bloomIntensity = intensity; this.save(); }
            setVignetteDarkness(darkness) { this.state.settings.vignetteDarkness = darkness; this.save(); }
            setAnimationsEnabled(enabled) { this.state.settings.animationsEnabled = enabled; this.save(); }
            setSoundsEnabled(enabled) { this.state.settings.soundsEnabled = enabled; this.save(); }
        }

        // --- App Manager ---
        class AppManager {
            constructor(ecs, stateManager, webGLRenderer, soundManager, fileSystem) {
                this.ecs = ecs;
                this.stateManager = stateManager;
                this.webGLRenderer = webGLRenderer;
                this.soundManager = soundManager;
                this.fileSystem = fileSystem;
                this.apps = {
                    about: {
                        title: 'ℹ️ About',
                        content: `<div style="padding:10px; font-size: 14px;">
                            <h3>P.O.P.S. OS Premium</h3>
                            <p>A WebGL-powered mini OS with advanced features.</p>
                            <b>Features:</b>
                            <ul>
                                <li>WebGL2 dynamic desktop with bloom and vignette</li>
                                <li>ECS architecture for scalability</li>
                                <li>Glassmorphism UI with animations</li>
                                <li>Persistent state with localStorage</li>
                                <li>3D desktop icons with glow effects</li>
                                <li>System audio feedback</li>
                                <li>Dynamic File Manager with virtual filesystem</li>
                                <li>Notepad with file editing and saving</li>
                                <li>Desktop-FileSystem integration with drag & drop</li>
                            </ul>
                        </div>`,
                        width: 450,
                        height: 350
                    },
                    notepad: {
                        title: '📝 Notepad',
                        content: (winId) => `
                            <div class="notepad-toolbar">
                                <button onclick="appManager.saveNotepadContent('${winId}')" aria-label="Save file">Save</button>
                                <button onclick="appManager.saveAsNotepadContent('${winId}')" aria-label="Save file as">Save As</button>
                            </div>
                            <textarea class="notepad-textarea" id="notepad-textarea-${winId}" placeholder="Start typing..."></textarea>
                        `,
                        width: 500,
                        height: 400
                    },
                    calculator: {
                        title: '🧮 Calculator',
                        content: `
                            <div class="calculator-grid">
                                <div class="calculator-display" id="calc-display-0">0</div>
                                <button onclick="appManager.calcInput('0', 'C')">C</button>
                                <button onclick="appManager.calcInput('0', '(')">(</button>
                                <button onclick="appManager.calcInput('0', ')')">)</button>
                                <button class="operator" onclick="appManager.calcInput('0', '/')">÷</button>
                                <button onclick="appManager.calcInput('0', '7')">7</button>
                                <button onclick="appManager.calcInput('0', '8')">8</button>
                                <button onclick="appManager.calcInput('0', '9')">9</button>
                                <button class="operator" onclick="appManager.calcInput('0', '*')">×</button>
                                <button onclick="appManager.calcInput('0', '4')">4</button>
                                <button onclick="appManager.calcInput('0', '5')">5</button>
                                <button onclick="appManager.calcInput('0', '6')">6</button>
                                <button class="operator" onclick="appManager.calcInput('0', '-')">-</button>
                                <button onclick="appManager.calcInput('0', '1')">1</button>
                                <button onclick="appManager.calcInput('0', '2')">2</button>
                                <button onclick="appManager.calcInput('0', '3')">3</button>
                                <button class="operator" onclick="appManager.calcInput('0', '+')">+</button>
                                <button class="span-two" onclick="appManager.calcInput('0', '0')">0</button>
                                <button onclick="appManager.calcInput('0', '.')">.</button>
                                <button class="operator" onclick="appManager.calcCalculate('0')">=</button>
                            </div>
                        `,
                        width: 300,
                        height: 400
                    },
                    filemanager: {
                        title: '📁 File Manager',
                        content: (winId) => `
                            <div class="file-manager" id="file-manager-${winId}">
                                <div class="sidebar">
                                    <div class="fs-item" data-path="/Desktop" onclick="appManager.navigateFileManager('${winId}', '/Desktop')" aria-label="Navigate to Desktop"><span>▶ Desktop</span></div>
                                    <div class="fs-item" data-path="/Documents" onclick="appManager.navigateFileManager('${winId}', '/Documents')" aria-label="Navigate to Documents"><span>▶ Documents</span></div>
                                    <div class="fs-item" data-path="/Pictures" onclick="appManager.navigateFileManager('${winId}', '/Pictures')" aria-label="Navigate to Pictures"><span>▶ Pictures</span></div>
                                </div>
                                <div class="main-content" id="file-content-${winId}" oncontextmenu="appManager.showFileContextMenu(event, '${winId}', '')">
                                </div>
                            </div>
                        `,
                        width: 550,
                        height: 350
                    },
                    settings: {
                        title: '⚙️ Settings',
                        content: `
                            <div class="settings-grid">
                                <label for="quality">Visual Quality:</label>
                                <select id="quality" onchange="appManager.updateQuality(this.value)">
                                    <option value="high">High</option>
                                    <option value="low">Low</option>
                                </select>
                                <label for="bloom-intensity">Bloom Intensity:</label>
                                <input type="range" id="bloom-intensity" min="0" max="2" step="0.1" value="${stateManager.state.settings.bloomIntensity}" oninput="appManager.updateBloomIntensity(this.value)">
                                <label for="vignette-darkness">Vignette Darkness:</label>
                                <input type="range" id="vignette-darkness" min="0" max="2" step="0.1" value="${stateManager.state.settings.vignetteDarkness}" oninput="appManager.updateVignetteDarkness(this.value)">
                                <label for="animations-enabled">Animations:</label>
                                <select id="animations-enabled" onchange="appManager.updateAnimationsEnabled(this.value)">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                                <label for="sounds-enabled">Sounds:</label>
                                <select id="sounds-enabled" onchange="appManager.updateSoundsEnabled(this.value)">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                        `,
                        width: 400,
                        height: 350
                    }
                };
                this.calcStates = {};
                this.fileManagerStates = {};
                this.notepadStates = {};
            }

            open(appId, options = {}) {
                this.soundManager.playSound('open');
                const app = this.apps[appId];
                if (!app) return;
                const winId = `win-${appId}-${Date.now()}`;
                const state = this.stateManager.getWindowState(winId);
                const entityId = this.ecs.createEntity();
                
                let content = typeof app.content === 'function' ? app.content(winId) : app.content;
                if (appId === 'calculator' || appId === 'settings') {
                    content = content
                        .replace(/calcInput\('0'/g, `calcInput('${winId}'`)
                        .replace(/calcCalculate\('0'/g, `calcCalculate('${winId}'`)
                        .replace('id="calc-display-0"', `id="calc-display-${winId}"`)
                        .replace('id="quality"', `id="quality-${winId}"`)
                        .replace('id="bloom-intensity"', `id="bloom-intensity-${winId}"`)
                        .replace('id="vignette-darkness"', `id="vignette-darkness-${winId}"`)
                        .replace('id="animations-enabled"', `id="animations-enabled-${winId}"`)
                        .replace('id="sounds-enabled"', `id="sounds-enabled-${winId}"`);
                }

                this.ecs.addComponent(entityId, 'Window', {
                    id: winId,
                    title: app.title,
                    content: content,
                    width: state.width || app.width,
                    height: state.height || app.height,
                    x: state.x || Math.random() * 150 + 50,
                    y: state.y || Math.random() * 200 + 50,
                    zIndex: ++topZIndex,
                    minimized: false,
                    maximized: false
                });
                this.ecs.addComponent(entityId, 'Draggable', {});
                this.ecs.addComponent(entityId, 'Taskbar', { title: app.title });
                if (appId === 'calculator') {
                    this.calcStates[winId] = '0';
                }
                if (appId === 'filemanager') {
                    this.fileManagerStates[winId] = { currentPath: '/Desktop' };
                    setTimeout(() => this.renderFileManager(winId, '/Desktop'), 0);
                }
                if (appId === 'notepad') {
                    this.notepadStates[winId] = { filePath: options.filePath || null, content: options.content || '' };
                    setTimeout(() => {
                        const textarea = document.getElementById(`notepad-textarea-${winId}`);
                        if (textarea && options.content) {
                            textarea.value = options.content;
                        }
                    }, 0);
                }
                if (appId === 'settings') {
                    setTimeout(() => {
                        const qualitySelect = document.getElementById(`quality-${winId}`);
                        const animationsSelect = document.getElementById(`animations-enabled-${winId}`);
                        const soundsSelect = document.getElementById(`sounds-enabled-${winId}`);
                        if (qualitySelect) qualitySelect.value = this.stateManager.state.settings.quality;
                        if (animationsSelect) animationsSelect.value = this.stateManager.state.settings.animationsEnabled.toString();
                        if (soundsSelect) soundsSelect.value = this.stateManager.state.settings.soundsEnabled.toString();
                    }, 0);
                }
                this.ecs.addComponent(entityId, 'Animation', { type: 'open' });
            }

            openTextFile(path) {
                const file = this.fileSystem.getPath(path);
                if (!file || file.type !== 'file' || !path.endsWith('.txt')) return;
                this.soundManager.playSound('open');
                this.open('notepad', { filePath: path, content: file.content });
            }

            saveNotepadContent(winId) {
                const textarea = document.getElementById(`notepad-textarea-${winId}`);
                if (!textarea) return;
                const state = this.notepadStates[winId];
                if (state.filePath) {
                    if (this.fileSystem.updateFileContent(state.filePath, textarea.value)) {
                        this.soundManager.playSound('save');
                        state.content = textarea.value;
                        if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                            const button = document.querySelector(`#${winId} .notepad-toolbar button[aria-label="Save file"]`);
                            if (button) {
                                button.animate(
                                    [
                                        { transform: 'scale(1)', background: 'rgba(255, 255, 255, 0.2)' },
                                        { transform: 'scale(1.2)', background: 'rgba(255, 255, 255, 0.4)' },
                                        { transform: 'scale(1)', background: 'rgba(255, 255, 255, 0.2)' }
                                    ],
                                    {
                                        duration: 200,
                                        easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                        fill: 'forwards'
                                    }
                                );
                            }
                        }
                    }
                } else {
                    this.saveAsNotepadContent(winId);
                }
            }

            saveAsNotepadContent(winId) {
                const textarea = document.getElementById(`notepad-textarea-${winId}`);
                if (!textarea) return;
                const content = textarea.value;
                const currentPath = this.fileManagerStates[Object.keys(this.fileManagerStates)[0]]?.currentPath || '/Desktop';
                const defaultName = 'NewNote.txt';
                const filePath = `${currentPath}/${defaultName}`;
                if (this.fileSystem.createItem(currentPath, defaultName, 'file', content)) {
                    this.soundManager.playSound('save');
                    this.notepadStates[winId].filePath = filePath;
                    this.notepadStates[winId].content = content;
                    if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                        const button = document.querySelector(`#${winId} .notepad-toolbar button[aria-label="Save file as"]`);
                        if (button) {
                            button.animate(
                                [
                                    { transform: 'scale(1)', background: 'rgba(255, 255, 255, 0.2)' },
                                    { transform: 'scale(1.2)', background: 'rgba(255, 255, 255, 0.4)' },
                                    { transform: 'scale(1)', background: 'rgba(255, 255, 255, 0.2)' }
                                ],
                                {
                                    duration: 200,
                                    easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                    fill: 'forwards'
                                }
                            );
                        }
                    }
                    this.refreshUI();
                }
            }

            calcInput(winId, val) {
                this.soundManager.playSound('click');
                const display = document.getElementById(`calc-display-${winId}`);
                if (!display) return;
                if (this.calcStates[winId] === '0' && val !== '.') {
                    this.calcStates[winId] = '';
                }
                this.calcStates[winId] += val;
                display.textContent = this.calcStates[winId];
            }

            calcCalculate(winId) {
                this.soundManager.playSound('click');
                const display = document.getElementById(`calc-display-${winId}`);
                if (!display) return;
                try {
                    const result = math.evaluate(this.calcStates[winId].replace('×', '*').replace('÷', '/'));
                    display.textContent = result;
                    this.calcStates[winId] = result.toString();
                } catch (e) {
                    display.textContent = 'Error';
                    this.calcStates[winId] = '0';
                }
            }

            navigateFileManager(winId, path) {
                this.soundManager.playSound('click');
                this.fileManagerStates[winId].currentPath = path;
                this.renderFileManager(winId, path);
            }

            renderFileManager(winId, path) {
                const content = document.getElementById(`file-content-${winId}`);
                if (!content) return;
                const items = this.fileSystem.listItems(path);
                content.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'fs-item';
                    div.dataset.path = item.path;
                    div.draggable = true;
                    div.setAttribute('aria-label', `${item.name} (${item.type})`);
                    div.innerHTML = `
                        <div class="icon-image">${item.type === 'folder' ? '📁' : '📄'}</div>
                        <span>${item.name}</span>
                        <input type="text" value="${item.name}" style="display: none;">
                    `;
                    div.onclick = (e) => {
                        e.stopPropagation();
                        this.soundManager.playSound('click');
                        if (item.type === 'folder') {
                            this.navigateFileManager(winId, item.path);
                        }
                    };
                    div.ondblclick = (e) => {
                        e.stopPropagation();
                        if (item.type === 'file' && item.name.endsWith('.txt')) {
                            this.openTextFile(item.path);
                        }
                    };
                    div.oncontextmenu = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.showFileContextMenu(e, winId, item.path);
                    };
                    if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                        div.animate(
                            [
                                { opacity: 0, transform: 'scale(0.8)' },
                                { opacity: 1, transform: 'scale(1)' }
                            ],
                            {
                                duration: 200,
                                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                fill: 'forwards'
                            }
                        );
                    }
                    content.appendChild(div);
                });
            }
            
            showFileContextMenu(e, winId, path) {
                this.soundManager.playSound('click');
                const existingMenu = document.querySelector('.file-context-menu');
                if (existingMenu) existingMenu.remove();
                const menu = document.createElement('div');
                menu.className = 'file-context-menu';
                menu.style.left = `${e.clientX}px`;
                menu.style.top = `${e.clientY}px`;
                const isTextFile = path && path.endsWith('.txt');
                const isFolder = path && this.fileSystem.getPath(path)?.type === 'folder';
                const currentPath = this.fileManagerStates[winId]?.currentPath || '/Desktop';
                menu.innerHTML = `
                    <ul>
                        ${isTextFile ? `<li onclick="appManager.openTextFile('${path}')">Open</li>` : ''}
                        <li onclick="appManager.createItem('${winId}', '${isFolder ? path : currentPath}')">New File</li>
                        <li onclick="appManager.createItem('${winId}', '${isFolder ? path : currentPath}', 'folder')">New Folder</li>
                        ${path ? `<li onclick="appManager.renameItem('${winId}', '${path}')">Rename</li>` : ''}
                        ${path ? `<li onclick="appManager.deleteItem('${winId}', '${path}')">Delete</li>` : ''}
                    </ul>
                `;
                document.body.appendChild(menu);
                menu.style.display = 'block';
                document.addEventListener('click', () => menu.remove(), { once: true });
            }
            
            createItem(winId, path, type = 'file') {
                const currentPath = path || this.fileManagerStates[winId]?.currentPath || '/Desktop';
                const defaultName = type === 'file' ? 'NewFile.txt' : 'NewFolder';
                const success = this.fileSystem.createItem(currentPath, defaultName, type);
                if (success) {
                    this.soundManager.playSound('create');
                    this.refreshUI();
                }
            }
            
            renameItem(winId, path) {
                const itemDiv = document.querySelector(`[data-path="${path}"]`);
                if (!itemDiv) return;
                const span = itemDiv.querySelector('span');
                const input = itemDiv.querySelector('input');
                span.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
                input.onblur = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== span.textContent) {
                        if (this.fileSystem.renameItem(path, newName)) {
                            this.soundManager.playSound('click');
                            this.refreshUI();
                        }
                    }
                    span.style.display = 'block';
                    input.style.display = 'none';
                };
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') input.blur();
                };
            }
            
            deleteItem(winId, path) {
                if (this.fileSystem.deleteItem(path)) {
                    this.soundManager.playSound('delete');
                    this.refreshUI();
                }
            }

            updateQuality(quality) { this.soundManager.playSound('click'); this.stateManager.setQuality(quality); }
            updateBloomIntensity(intensity) { this.soundManager.playSound('click'); this.stateManager.setBloomIntensity(parseFloat(intensity)); this.webGLRenderer.setBloomIntensity(parseFloat(intensity)); }
            updateVignetteDarkness(darkness) { this.soundManager.playSound('click'); this.stateManager.setVignetteDarkness(parseFloat(darkness)); this.webGLRenderer.setVignetteDarkness(parseFloat(darkness)); }
            updateAnimationsEnabled(enabled) { this.soundManager.playSound('click'); this.stateManager.setAnimationsEnabled(enabled === 'true'); }
            updateSoundsEnabled(enabled) { this.soundManager.playSound('click'); this.stateManager.setSoundsEnabled(enabled === 'true'); }

            refreshUI() {
                this.renderDesktopIcons();
                Object.keys(this.fileManagerStates).forEach(winId => {
                    const fmWindow = document.getElementById(`file-manager-${winId}`);
                    if (fmWindow) {
                        this.renderFileManager(winId, this.fileManagerStates[winId].currentPath);
                    }
                });
            }

            renderDesktopIcons() {
                const desktop = document.getElementById('desktop');
                desktop.innerHTML = ''; // Clear existing icons
                const items = this.fileSystem.listItems('/Desktop');
                
                items.forEach(item => {
                    const icon = document.createElement('div');
                    icon.className = 'icon';
                    icon.draggable = true;
                    icon.dataset.path = item.path;
                    icon.setAttribute('aria-label', `${item.name} (${item.type})`);
                    icon.innerHTML = `
                        <div class="icon-image">${item.type === 'folder' ? '📁' : '📄'}</div>
                        <span>${item.name}</span>
                        <input type="text" value="${item.name}" style="display: none;">
                    `;
                    icon.ondblclick = (e) => {
                        e.stopPropagation();
                        if (item.type === 'file' && item.name.endsWith('.txt')) {
                            this.openTextFile(item.path);
                        }
                    };
                    icon.oncontextmenu = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.showFileContextMenu(e, 'desktop', item.path);
                    };
                    desktop.appendChild(icon);
                });
                
                this.webGLRenderer.syncIconMeshes(items);
            }
        }

        // --- Systems ---
        class RenderSystem {
            update(ecs) {
                const desktop = document.getElementById('desktop');
                ecs.entities.forEach((entity, id) => {
                    if (!entity.components.has('Window')) return;
                    const winData = entity.components.get('Window');
                    let win = document.getElementById(winData.id);
                    if (!win) {
                        win = document.createElement('div');
                        win.id = winData.id;
                        win.className = 'window';
                        win.innerHTML = `
                            <div class="title-bar">
                                <span>${winData.title}</span>
                                <div class="title-bar-buttons">
                                    <button class="minimize" onclick="windowSystem.minimize('${id}')">_</button>
                                    <button class="maximize" onclick="windowSystem.maximize('${id}')">□</button>
                                    <button class="close" onclick="windowSystem.close('${id}')">×</button>
                                </div>
                            </div>
                            <div class="window-content">${winData.content}</div>`;
                        desktop.appendChild(win);
                    }
                    if (!entity.components.has('Animation')) {
                        win.style.width = `${winData.width}px`;
                        win.style.height = `${winData.height}px`;
                        win.style.top = `${winData.y}px`;
                        win.style.left = `${winData.x}px`;
                        win.style.zIndex = winData.zIndex;
                        win.style.transform = winData.minimized ? 'scale(0.8) translateY(200px)' : 'none';
                        win.style.opacity = winData.minimized ? '0' : '1';
                        win.style.pointerEvents = winData.minimized ? 'none' : 'auto';
                    }
                });
            }
        }

        class DragSystem {
            constructor() {
                this.isDragging = null;
                this.offsetX = 0;
                this.offsetY = 0;
                this.snapTarget = null;
                document.addEventListener('mousemove', this.drag.bind(this));
                document.addEventListener('mouseup', this.stopDrag.bind(this));
            }

            update(ecs) {
                ecs.entities.forEach((entity, id) => {
                    if (!entity.components.has('Draggable') || !entity.components.has('Window')) return;
                    const win = document.getElementById(entity.components.get('Window').id);
                    if (!win) return;
                    const titleBar = win.querySelector('.title-bar');
                    titleBar.onmousedown = (e) => {
                        if (e.target.tagName === 'BUTTON') return;
                        e.preventDefault();
                        if (entity.components.get('Window').maximized) return;
                        this.isDragging = id;
                        this.offsetX = e.clientX - entity.components.get('Window').x;
                        this.offsetY = e.clientY - entity.components.get('Window').y;
                        ecs.addComponent(id, 'Window', { ...entity.components.get('Window'), zIndex: ++topZIndex });
                    };
                });
            }

            drag(e) {
                if (!this.isDragging) return;
                const entity = ecs.entities.get(this.isDragging);
                const winData = entity.components.get('Window');
                const desktop = document.getElementById('desktop');
                const taskbar = document.querySelector('.taskbar');
                const desktopHeight = desktop.clientHeight - taskbar.clientHeight;
                const snapPreview = document.getElementById('snap-preview');

                const newX = e.clientX - this.offsetX;
                const newY = e.clientY - this.offsetY;

                if (e.clientX < 5) {
                    snapPreview.style.display = 'block';
                    snapPreview.style.left = '0px';
                    snapPreview.style.top = '0px';
                    snapPreview.style.width = '50%';
                    snapPreview.style.height = `${desktopHeight}px`;
                    this.snapTarget = 'left';
                } else if (e.clientX > desktop.clientWidth - 5) {
                    snapPreview.style.display = 'block';
                    snapPreview.style.left = '50%';
                    snapPreview.style.top = '0px';
                    snapPreview.style.width = '50%';
                    snapPreview.style.height = `${desktopHeight}px`;
                    this.snapTarget = 'right';
                } else {
                    snapPreview.style.display = 'none';
                    this.snapTarget = null;
                }

                ecs.addComponent(this.isDragging, 'Window', { ...winData, x: newX, y: newY });
            }

            stopDrag() {
                if (!this.isDragging) return;
                const entity = ecs.entities.get(this.isDragging);
                const winData = entity.components.get('Window');
                const desktop = document.getElementById('desktop');
                const taskbar = document.querySelector('.taskbar');
                const desktopHeight = desktop.clientHeight - taskbar.clientHeight;

                if (this.snapTarget) {
                    let newData = { ...winData, y: 0, width: desktop.clientWidth / 2, height: desktopHeight };
                    if (this.snapTarget === 'left') {
                        newData.x = 0;
                    } else if (this.snapTarget === 'right') {
                        newData.x = desktop.clientWidth / 2;
                    }
                    ecs.addComponent(this.isDragging, 'Window', newData);
                    stateManager.setWindowState(winData.id, newData);
                } else {
                    stateManager.setWindowState(winData.id, winData);
                }

                this.isDragging = null;
                this.snapTarget = null;
                document.getElementById('snap-preview').style.display = 'none';
            }
        }

        class WindowSystem {
            constructor(stateManager, ecs, soundManager) {
                this.stateManager = stateManager;
                this.ecs = ecs;
                this.soundManager = soundManager;
            }

        close(entityId) {
    const winData = this.ecs.getComponent(entityId, 'Window');
    const win = document.getElementById(winData.id);
    if (!win) return;
    this.soundManager.playSound('close');

    if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        this.ecs.addComponent(entityId, 'Animation', { type: 'close' });
    } else {
        win.style.transform = 'scale(0.8)';
        win.style.opacity = '0';
        setTimeout(() => {
            win.remove();
            this.ecs.entities.get(entityId)?.components.delete('Taskbar'); // ✅ Remove Taskbar entry
            this.ecs.entities.delete(entityId);
            delete appManager.calcStates[winData.id];
            delete appManager.fileManagerStates[winData.id];
            delete appManager.notepadStates[winData.id];
        }, 200);
    }
}


            minimize(entityId) {
                this.soundManager.playSound('minimize');
                const winData = this.ecs.getComponent(entityId, 'Window');
                if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    this.ecs.addComponent(entityId, 'Animation', { type: 'minimize' });
                } else {
                    this.ecs.addComponent(entityId, 'Window', { ...winData, minimized: true });
                    this.stateManager.setWindowState(winData.id, { ...winData, minimized: true });
                }
            }

            maximize(entityId) {
                this.soundManager.playSound('maximize');
                const winData = this.ecs.getComponent(entityId, 'Window');
                const desktop = document.getElementById('desktop');
                const taskbar = document.querySelector('.taskbar');
                const newData = winData.maximized
                    ? { ...winData, ...winData.originalRect, maximized: false }
                    : {
                        ...winData,
                        originalRect: { x: winData.x, y: winData.y, width: winData.width, height: winData.height },
                        x: 0,
                        y: 0,
                        width: desktop.clientWidth,
                        height: desktop.clientHeight - taskbar.clientHeight,
                        maximized: true
                    };
                if (this.stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    this.ecs.addComponent(entityId, 'Animation', { type: winData.maximized ? 'restore' : 'maximize', targetData: newData });
                } else {
                    this.ecs.addComponent(entityId, 'Window', newData);
                    this.stateManager.setWindowState(winData.id, newData);
                }
            }
        }

        class TaskbarSystem {
            update(ecs) {
                const taskbarApps = document.getElementById('taskbar-apps');
                taskbarApps.innerHTML = '';
                ecs.entities.forEach((entity, id) => {
                    if (!entity.components.has('Taskbar') || !entity.components.has('Window')) return;
                    const winData = entity.components.get('Window');
                    const taskData = entity.components.get('Taskbar');
                    const item = document.createElement('div');
                    item.className = 'taskbar-item';
                    item.id = `taskbar-${winData.id}`;
                    item.textContent = taskData.title.substring(0, 10) + (taskData.title.length > 10 ? '...' : '');
                    item.onclick = () => {
                        soundManager.playSound('click');
                        const winData = ecs.getComponent(id, 'Window');
                        if (winData.minimized) {
                            ecs.addComponent(id, 'Window', { ...winData, minimized: false, zIndex: ++topZIndex });
                            stateManager.setWindowState(winData.id, { ...winData, minimized: false, zIndex });
                            if (stateManager.state.settings.animationsEnabled && !window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                                ecs.addComponent(id, 'Animation', { type: 'restore' });
                            }
                        } else {
                            ecs.addComponent(id, 'Window', { ...winData, zIndex: ++topZIndex });
                        }
                    };
                    if (winData.zIndex === topZIndex && !winData.minimized) {
                        item.classList.add('active');
                    }
                    taskbarApps.appendChild(item);
                });
            }
        }

        class AnimationSystem {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.activeAnimations = new Map();
            }

            update(ecs) {
                if (!this.stateManager.state.settings.animationsEnabled || window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    ecs.entities.forEach((entity, id) => {
                        if (entity.components.has('Animation')) {
                            ecs.entities.get(id).components.delete('Animation');
                        }
                    });
                    return;
                }

                ecs.entities.forEach((entity, id) => {
                    if (!entity.components.has('Animation') || !entity.components.has('Window')) return;
                    const winData = entity.components.get('Window');
                    const animData = entity.components.get('Animation');
                    const win = document.getElementById(winData.id);
                    if (!win) return;

                    if (this.activeAnimations.has(id)) {
                        this.activeAnimations.get(id).cancel();
                        this.activeAnimations.delete(id);
                    }

                    let animation;
                    if (animData.type === 'open') {
                        animation = win.animate(
                            [
                                { transform: 'scale(0.9)', opacity: 0 },
                                { transform: 'scale(1)', opacity: 1 }
                            ],
                            {
                                duration: 300,
                                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                fill: 'forwards'
                            }
                        );
                    } else if (animData.type === 'close') {
                        animation = win.animate(
                            [
                                { transform: 'scale(1)', opacity: 1 },
                                { transform: 'scale(0.8)', opacity: 0 }
                            ],
                            {
                                duration: 200,
                                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                fill: 'forwards'
                            }
                        );
                        animation.onfinish = () => {
                            win.remove();
                            ecs.entities.delete(id);
                            delete appManager.calcStates[winData.id];
                            delete appManager.fileManagerStates[winData.id];
                            delete appManager.notepadStates[winData.id];
                        };
                    } else if (animData.type === 'minimize') {
                        animation = win.animate(
                            [
                                { transform: 'scale(1)', opacity: 1 },
                                { transform: 'scale(0.8) translateY(200px)', opacity: 0 }
                            ],
                            {
                                duration: 300,
                                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                fill: 'forwards'
                            }
                        );
                        animation.onfinish = () => {
                            ecs.addComponent(id, 'Window', { ...winData, minimized: true });
                            stateManager.setWindowState(winData.id, { ...winData, minimized: true });
                        };
                    } else if (animData.type === 'maximize' || animData.type === 'restore') {
                        const targetData = animData.targetData;
                        const startRect = win.getBoundingClientRect();
                        const endRect = {
                            x: targetData.x,
                            y: targetData.y,
                            width: targetData.width,
                            height: targetData.height
                        };
                        animation = win.animate(
                            [
                                {
                                    transform: `translate(${startRect.left}px, ${startRect.top}px) scale(${startRect.width / targetData.width}, ${startRect.height / targetData.height})`,
                                    opacity: 1
                                },
                                {
                                    transform: `translate(${endRect.x}px, ${endRect.y}px) scale(1)`,
                                    opacity: 1
                                }
                            ],
                            {
                                duration: 300,
                                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                                fill: 'forwards'
                            }
                        );
                        animation.onfinish = () => {
                            ecs.addComponent(id, 'Window', targetData);
                            stateManager.setWindowState(winData.id, targetData);
                        };
                    }

                    if (animation) {
                        this.activeAnimations.set(id, animation);
                        animation.onfinish = () => {
                            this.activeAnimations.delete(id);
                            ecs.entities.get(id)?.components.delete('Animation');
                            if (animation.onfinish) animation.onfinish();
                        };
                    }

                    ecs.entities.get(id).components.delete('Animation');
                });
            }
        }

        // --- WebGL Renderer with 3D Icons ---
        class WebGLRenderer {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.canvas = document.getElementById('webgl-canvas');
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.camera.position.z = 50;

                // Initialize EffectComposer
                this.composer = new THREE.EffectComposer(this.renderer);
                this.composer.addPass(new THREE.RenderPass(this.scene, this.camera));

                // Add UnrealBloomPass
                this.bloomPass = new THREE.UnrealBloomPass(
                    new THREE.Vector2(window.innerWidth, window.innerHeight),
                    this.stateManager.state.settings.bloomIntensity,
                    0.4,
                    0.85
                );
                this.composer.addPass(this.bloomPass);

                // Add VignettePass
                this.vignettePass = new THREE.ShaderPass(THREE.VignetteShader);
                this.vignettePass.uniforms['offset'].value = 1.0;
                this.vignettePass.uniforms['darkness'].value = this.stateManager.state.settings.vignetteDarkness;
                this.composer.addPass(this.vignettePass);

                // Parallax background
                const geometry = new THREE.PlaneGeometry(100, 100);
                const material = new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load('https://source.unsplash.com/random/1920x1080?abstract'),
                    transparent: true,
                    opacity: 0.8,
                    roughness: 0.2,
                    metalness: 0.1
                });
                this.background = new THREE.Mesh(geometry, material);
                this.scene.add(this.background);

                // Particle system
                this.particles = new THREE.Group();
                for (let i = 0; i < 100; i++) {
                    const particle = new THREE.Mesh(
                        new THREE.SphereGeometry(0.1, 16, 16),
                        new THREE.MeshStandardMaterial({
                            color: 0xffffff,
                            emissive: 0xaaaaaa,
                            emissiveIntensity: 0.5,
                            transparent: true,
                            opacity: 0.7
                        })
                    );
                    particle.position.set(
                        (Math.random() - 0.5) * 100,
                        (Math.random() - 0.5) * 100,
                        (Math.random() - 0.5) * 50
                    );
                    this.particles.add(particle);
                }
                this.scene.add(this.particles);

                // 3D Desktop Icons
                this.iconMeshes = new Map();
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 0.5, 100);
                pointLight.position.set(10, 10, 10);
                this.scene.add(pointLight);

                // Animation loop
                this.animate = this.animate.bind(this);
                this.animate();

                // Handle resize
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.composer.setSize(window.innerWidth, window.innerHeight);
                    this.updateIconPositions();
                });
            }

            setBloomIntensity(intensity) {
                this.bloomPass.strength = intensity;
            }

            setVignetteDarkness(darkness) {
                this.vignettePass.uniforms['darkness'].value = darkness;
            }
            
            syncIconMeshes(items) {
                // Remove meshes for deleted icons
                this.iconMeshes.forEach((mesh, path) => {
                    if (!items.find(item => item.path === path)) {
                        this.scene.remove(mesh);
                        this.iconMeshes.delete(path);
                    }
                });

                // Add meshes for new icons
                items.forEach(item => {
                    if (!this.iconMeshes.has(item.path)) {
                        const iconGeometry = new THREE.BoxGeometry(2, 2, 0.5);
                        const iconMaterial = new THREE.MeshStandardMaterial({
                            color: 0x6cbeff,
                            emissive: 0x6cbeff,
                            emissiveIntensity: 0.5,
                            transparent: true,
                            opacity: 0.8,
                            roughness: 0.3,
                            metalness: 0.2
                        });
                        const mesh = new THREE.Mesh(iconGeometry, iconMaterial.clone());
                        mesh.userData.path = item.path;
                        this.scene.add(mesh);
                        this.iconMeshes.set(item.path, mesh);
                    }
                });
                this.updateIconPositions();
            }

            updateIconPositions() {
                document.querySelectorAll('.icon').forEach(icon => {
                    const path = icon.dataset.path;
                    const mesh = this.iconMeshes.get(path);
                    if (!mesh) return;
                    const rect = icon.getBoundingClientRect();
                    const x = (rect.left / window.innerWidth) * 100 - 50;
                    const y = -(rect.top / window.innerHeight) * 100 + 50;
                    mesh.position.set(x, y, 5);
                    mesh.rotation.y = Math.sin(Date.now() * 0.001) * 0.2;
                });
            }

            animate() {
                requestAnimationFrame(this.animate);
                this.particles.rotation.y += 0.001;
                this.updateIconPositions();
                if (this.stateManager.state.settings.quality === 'high') {
                    this.composer.render();
                } else {
                    this.renderer.render(this.scene, this.camera);
                }
            }
        }

        // --- Initialize ---
        let topZIndex = 1;
        const ecs = new ECS();
        const stateManager = new StateManager();
        const fileSystem = new FileSystem(stateManager);
        const soundManager = new SoundManager(stateManager);
        const webGLRenderer = new WebGLRenderer(stateManager);
        const appManager = new AppManager(ecs, stateManager, webGLRenderer, soundManager, fileSystem);
        const windowSystem = new WindowSystem(stateManager, ecs, soundManager);
        ecs.addSystem(new RenderSystem());
        ecs.addSystem(new DragSystem());
        ecs.addSystem(new TaskbarSystem());
        ecs.addSystem(new AnimationSystem(stateManager));
        
        // --- Drag and Drop Logic ---
        let draggedElementPath = null;
        document.addEventListener('dragstart', (e) => {
            const target = e.target.closest('.fs-item, .icon');
            if (target) {
                draggedElementPath = target.dataset.path;
                e.dataTransfer.setData('text/plain', draggedElementPath);
            }
        });
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dropTarget = e.target.closest('.fs-item, .icon, #desktop');
            document.querySelectorAll('.drop-hover').forEach(el => el.classList.remove('drop-hover'));
            if (dropTarget) {
                let targetPath = dropTarget.dataset.path;
                if (dropTarget.id === 'desktop') targetPath = '/Desktop';
                const targetNode = fileSystem.getPath(targetPath);
                if (targetNode && targetNode.type === 'folder') {
                    dropTarget.classList.add('drop-hover');
                }
            }
        });
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.drop-hover').forEach(el => el.classList.remove('drop-hover'));
            const dropTarget = e.target.closest('.fs-item, .icon, #desktop');
            if (dropTarget && draggedElementPath) {
                let destPath = dropTarget.dataset.path;
                if (dropTarget.id === 'desktop') destPath = '/Desktop';
                if (fileSystem.moveItem(draggedElementPath, destPath)) {
                    soundManager.playSound('drop');
                    appManager.refreshUI();
                }
                draggedElementPath = null;
            }
        });


        // --- Keyboard Shortcuts for Notepad ---
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const activeWin = document.querySelector(`.window[style*="z-index: ${topZIndex}"]`);
                if (activeWin && activeWin.id.startsWith('win-notepad')) {
                    appManager.saveNotepadContent(activeWin.id);
                }
            }
        });

        // --- Start Menu & Context Menu ---
        document.getElementById('start-button').addEventListener('click', (e) => {
            e.stopPropagation();
            soundManager.playSound('click');
            document.getElementById('start-menu').classList.toggle('show');
        });

        document.addEventListener('click', (e) => {
            const startMenu = document.getElementById('start-menu');
            const startButton = document.getElementById('start-button');
            if (startMenu && !startMenu.contains(e.target) && e.target !== startButton) {
                startMenu.classList.remove('show');
            }
            document.getElementById('context-menu').style.display = 'none';
            const fileContextMenu = document.querySelector('.file-context-menu');
            if (fileContextMenu && !fileContextMenu.contains(e.target)) {
                fileContextMenu.remove();
            }
        });

        document.getElementById('desktop').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            soundManager.playSound('click');
            const menu = document.getElementById('context-menu');
            menu.innerHTML = `
                <ul>
                    <li onclick="appManager.createItem('desktop', '/Desktop', 'file')">New File</li>
                    <li onclick="appManager.createItem('desktop', '/Desktop', 'folder')">New Folder</li>
                    <hr>
                    <li onclick="changeBackground()">Change Background</li>
                    <li onclick="appManager.open('settings')">Settings</li>
                    <hr>
                    <li onclick="appManager.open('about')">About P.O.P.S. OS</li>
                </ul>
            `;
            menu.style.display = 'block';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
        });

        function changeBackground() {
            soundManager.playSound('click');
            webGLRenderer.background.material.map = new THREE.TextureLoader().load(`https://source.unsplash.com/random/1920x1080?abstract,${Math.random()}`);
            document.getElementById('context-menu').style.display = 'none';
        }

        // --- Clock ---
        function updateClock() {
            const clockElement = document.getElementById('clock');
            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const date = now.toLocaleDateString([], { month: '2-digit', day: '2-digit', year: 'numeric' });
            clockElement.innerHTML = `${time}<br>${date}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- ECS Update Loop ---
        function gameLoop() {
            ecs.update();
            requestAnimationFrame(gameLoop);
        }
        gameLoop();

        // --- Initial Load ---
        window.onload = function() {
            appManager.refreshUI();
            appManager.open('about');
        };
    </script>
</body>
</html>
